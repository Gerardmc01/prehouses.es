<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Empresa | Prehouses</title>
    <!-- CSS Dependencies -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>

    <div class="dashboard-layout">
        <!-- SIDEBAR -->
        <aside class="dash-sidebar" style="background-color: #064e3b;"> <!-- Dark Emerald for Companies -->
            <a href="index.html" class="dash-logo">
                <i class="fa-solid fa-house-chimney"></i>
                <span>Prehouses<small
                        style="font-size: 0.7rem; display: block; opacity: 0.7; font-weight: 400;">Business</small></span>
            </a>

            <div class="user-profile-mini">
                <div class="user-avatar" id="sidebarAvatar"
                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <i class="fa-solid fa-building"></i>
                </div>
                <div class="user-info-mini">
                    <h4 id="companyName">Cargando...</h4>
                    <p id="userEmail">...</p>
                </div>
            </div>

            <nav class="dash-nav">
                <a href="#" class="dash-link active">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>Resumen</span>
                </a>
                <a href="#" class="dash-link"
                    onclick="document.getElementById('inventorySection').scrollIntoView({behavior: 'smooth'})">
                    <i class="fa-solid fa-list-check"></i>
                    <span>Mis Propiedades</span>
                </a>
                <a href="#" class="dash-link"
                    onclick="document.getElementById('leadsSection').scrollIntoView({behavior: 'smooth'})">
                    <i class="fa-solid fa-inbox"></i>
                    <span>Mensajes (Leads)</span>
                </a>
                <a href="#" class="dash-link" onclick="openComingSoonModal('Anal√≠tica Avanzada')">
                    <i class="fa-solid fa-chart-pie"></i>
                    <span>Estad√≠sticas</span>
                </a>
                <a href="#" class="dash-link" onclick="openComingSoonModal('Publicidad Premium')">
                    <i class="fa-solid fa-bullhorn"></i>
                    <span>Promoci√≥n</span>
                </a>
                <a href="#" class="dash-link" onclick="openProfileModal()">
                    <i class="fa-solid fa-business-time"></i>
                    <span>Perfil Empresa</span>
                </a>

                <a href="#" onclick="logout()" class="dash-link logout">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span>Cerrar Sesi√≥n</span>
                </a>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="dash-main">
            <header class="dash-header">
                <div class="dash-title">
                    <div class="breadcrumb">Business Center / Vista General</div>
                    <h1 id="welcomeTitle">Panel de Control</h1>
                </div>

                <div class="dash-search-container">
                    <div class="dash-search">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" placeholder="Buscar propiedades, clientes...">
                    </div>
                </div>
            </header>

            <!-- Status Banner -->
            <div id="statusBanner" style="display: none;"></div>

            <!-- STATS ROW -->
            <div class="dash-grid-stats">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon green">
                            <i class="fa-solid fa-home"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="casasCount">0</div>
                    <div class="stat-label">Casas Publicadas</div>
                    <a href="publicar-casa.html" class="btn-dash btn-dash-primary"
                        style="margin-top: 15px; width: 100%; text-decoration: none; text-align: center;">
                        <i class="fa-solid fa-plus"></i> Nueva Casa
                    </a>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon blue">
                            <i class="fa-solid fa-envelope-open-text"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="consultasCount">0</div>
                    <div class="stat-label">Leads Recibidos</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon purple">
                            <i class="fa-solid fa-eye"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="viewsCount">0</div>
                    <div class="stat-label">Visualizaciones</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon orange">
                            <i class="fa-solid fa-star"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="ratingCount">-</div>
                    <div class="stat-label">Valoraci√≥n Media</div>
                </div>
            </div>

            <!-- INVENTORY SECTION -->
            <div class="section-header" id="inventorySection" style="margin-top: 50px;">
                <h2>Gesti√≥n de Inventario</h2>
                <button onclick="window.location.href='publicar-casa.html'" class="btn-dash btn-dash-primary">
                    <i class="fa-solid fa-plus"></i> Publicar Propiedad
                </button>
            </div>

            <div class="dashboard-card"
                style="padding: 0; overflow: hidden; border: 1px solid #e2e8f0; border-radius: 16px;">
                <div id="myHousesList">
                    <!-- Loading State -->
                    <div class="empty-dashboard">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        <p>Cargando inventario...</p>
                    </div>
                </div>
            </div>

            <!-- LEADS SECTION -->
            <div class="section-header" id="leadsSection" style="margin-top: 60px;">
                <h2>√öltimos Mensajes (Leads)</h2>
                <button onclick="loadLeads()" class="btn-dash btn-dash-outline">
                    <i class="fa-solid fa-rotate"></i> Actualizar
                </button>
            </div>

            <div id="leadsList">
                <div class="empty-dashboard">
                    <p>Cargando mensajes recientes...</p>
                </div>
            </div>

            <!-- COMPANY INFO MINI -->
            <div class="dashboard-card" style="margin-top: 50px; background: #f8fafc; border: 1px solid #e2e8f0;">
                <div class="section-header" style="margin-bottom: 15px;">
                    <h3 style="font-size: 1.1rem;"><i class="fa-solid fa-building"></i> Informaci√≥n de Registro</h3>
                    <button onclick="openProfileModal()" class="btn-dash btn-dash-outline btn-sm">Editar</button>
                </div>
                <div id="companyInfo"
                    style="font-size: 0.9rem; color: #64748b; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <!-- Populated by JS -->
                </div>
            </div>

        </main>
    </div>

    <!-- Modal Editar Perfil -->
    <div id="profileModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1100; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; position: relative;">
            <span onclick="closeProfileModal()"
                style="position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 1.5rem;">&times;</span>
            <h2 style="margin-bottom: 20px; color: var(--secondary);">Editar Perfil de Empresa</h2>
            <form id="profileForm" onsubmit="handleUpdateProfile(event)">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nombre Comercial</label>
                    <input type="text" id="editName" required
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tel√©fono de Contacto</label>
                    <input type="tel" id="editPhone" required
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">CIF / NIF</label>
                    <input type="text" id="editCif"
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Sitio Web</label>
                    <input type="url" id="editWebsite" placeholder="https://..."
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <!-- Modal Editar Casa -->
    <div id="editHouseModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1100; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 600px; position: relative; max-height: 90vh; overflow-y: auto;">
            <span onclick="closeEditHouseModal()"
                style="position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 1.5rem;">&times;</span>
            <h2 style="margin-bottom: 20px; color: var(--secondary);">Editar Propiedad</h2>
            <form id="editHouseForm" onsubmit="handleUpdateHouse(event)">
                <input type="hidden" id="editHouseId">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">T√≠tulo</label>
                    <input type="text" id="editHouseTitle" required
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Precio (‚Ç¨)</label>
                        <input type="number" id="editHousePrice" required
                            style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Superficie (m¬≤)</label>
                        <input type="number" id="editHouseArea" required
                            style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Imagen Principal (URL)</label>
                    <input type="url" id="editHouseImage" required
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Descripci√≥n</label>
                    <textarea id="editHouseDesc" rows="4"
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Actualizar Propiedad</button>
            </form>
        </div>
    </div>

    <!-- Modal Coming Soon -->
    <div id="comingSoonModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1200; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; position: relative; animation: slideIn 0.3s ease;">
            <span onclick="document.getElementById('comingSoonModal').style.display='none'"
                style="position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 1.5rem;">&times;</span>
            <div
                style="background: #f0fdf4; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <i class="fa-solid fa-rocket" style="font-size: 2.5rem; color: #059669;"></i>
            </div>
            <h2 id="comingSoonTitle" style="margin-bottom: 10px; color: var(--secondary);">Pr√≥ximamente</h2>
            <p style="color: #64748b; line-height: 1.6;">Estamos trabajando duro para traer <strong
                    id="comingSoonFeature">esta caracter√≠stica</strong> muy pronto. ¬°Mantente atento a las
                actualizaciones!</p>
            <button onclick="document.getElementById('comingSoonModal').style.display='none'" class="btn btn-primary"
                style="margin-top: 25px; width: 100%;">¬°Entendido!</button>
        </div>
    </div>

    <!-- Firebase Config -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/support.js"></script>
    <script src="js/toast.js"></script>

    <script>
        let currentUser = null;
        let userData = null;

        // Proteger p√°gina - solo empresas
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'empresas.html';
                return;
            }

            currentUser = user;

            try {
                const userDoc = await db.collection('users').doc(user.uid).get();

                if (!userDoc.exists) {
                    alert('Error: No se encontraron datos de usuario');
                    window.location.href = 'empresas.html';
                    return;
                }

                userData = userDoc.data();

                // Verificar que es una empresa
                if (userData.userType !== 'empresa') {
                    window.location.href = 'dashboard-usuario.html';
                    return;
                }

                // Cargar datos
                await loadCompanyData();

            } catch (error) {
                alert('Error al cargar: ' + error.message);
                window.location.href = 'empresas.html';
            }
        });

        // Cargar datos de la empresa
        async function loadCompanyData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                userData = userDoc.exists ? userDoc.data() : {};

                if (userData.userType !== 'empresa') {
                    alert('‚ö†Ô∏è Esta p√°gina es solo para empresas');
                    window.location.href = 'dashboard-usuario.html';
                    return;
                }

                // Actualizar Sidebar & Header
                const companyName = userData.name || 'Empresa';
                document.getElementById('companyName').textContent = companyName;
                document.getElementById('welcomeTitle').textContent = `Panel de Control, ${companyName}`;
                document.getElementById('userEmail').textContent = currentUser.email;

                // Calcular estad√≠sticas reales desde Firestore
                try {
                    const housesSnapshot = await db.collection('houses')
                        .where('companyId', '==', currentUser.uid)
                        .get();

                    const leadsSnapshot = await db.collection('leads')
                        .where('companyId', '==', currentUser.uid)
                        .get();

                    document.getElementById('casasCount').textContent = housesSnapshot.size;
                    document.getElementById('consultasCount').textContent = leadsSnapshot.size;

                    // Views count (placeholder - would need analytics tracking)
                    document.getElementById('viewsCount').textContent = userData.visualizaciones || 0;
                    document.getElementById('ratingCount').textContent = userData.rating || '-';

                } catch (statsError) {
                    console.error('Error loading stats:', statsError);
                    // Fallback to user data if queries fail
                    document.getElementById('casasCount').textContent = userData.casasPublicadas || 0;
                    document.getElementById('consultasCount').textContent = userData.consultas || 0;
                    document.getElementById('viewsCount').textContent = userData.visualizaciones || 0;
                    document.getElementById('ratingCount').textContent = userData.rating || '-';
                }

                // Informaci√≥n detallada
                const companyInfoEl = document.getElementById('companyInfo');
                if (companyInfoEl) {
                    const fechaRegistro = userData.createdAt?.toDate().toLocaleDateString('es-ES') || 'N/A';
                    companyInfoEl.innerHTML = `
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #f1f5f9;"><strong>Nombre:</strong><br>${userData.name || 'No especificado'}</div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #f1f5f9;"><strong>Email:</strong><br>${currentUser.email}</div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #f1f5f9;"><strong>CIF:</strong><br>${userData.cif || 'No especificado'}</div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #f1f5f9;"><strong>Tel√©fono:</strong><br>${userData.phone || 'No especificado'}</div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #f1f5f9;"><strong>Estado:</strong><br>${getStatusText(userData.status)}</div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #f1f5f9;"><strong>Miembro desde:</strong><br>${fechaRegistro}</div>
                    `;
                }

                // Mostrar banner de estado
                showStatusBanner(userData.status);

                // Cargar leads y analytics
                try {
                    await loadLeads();
                } catch (e) {
                    console.error('Error loading leads:', e);
                }

                try {
                    await loadAnalytics();
                    await loadInventory();
                } catch (e) {
                    console.error('Error loading analytics/inventory:', e);
                }

            } catch (error) {
                console.error('Error in loadCompanyData:', error);
            }
        }

        // --- PROFILE MANAGEMENT ---
        function openProfileModal() {
            document.getElementById('editName').value = userData.name || '';
            document.getElementById('editPhone').value = userData.phone || '';
            document.getElementById('editCif').value = userData.cif || '';
            document.getElementById('editWebsite').value = userData.website || '';
            document.getElementById('profileModal').style.display = 'flex';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        async function handleUpdateProfile(e) {
            e.preventDefault();
            const updates = {
                name: document.getElementById('editName').value,
                phone: document.getElementById('editPhone').value,
                cif: document.getElementById('editCif').value,
                website: document.getElementById('editWebsite').value
            };

            try {
                await db.collection('users').doc(currentUser.uid).update(updates);
                showToast('Perfil actualizado correctamente', 'success');
                closeProfileModal();
                loadCompanyData(); // Reload UI
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('Error al actualizar perfil', 'error');
            }
        }

        // --- INVENTORY MANAGEMENT ---
        async function loadInventory() {
            const container = document.getElementById('myHousesList');
            try {
                const snapshot = await db.collection('houses')
                    .where('companyId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    container.innerHTML = `<div class="empty-dashboard"><p>No tienes casas publicadas.</p><button onclick="window.location.href='publicar-casa.html'" class="btn-dash btn-dash-primary" style="margin-top:10px;">Publicar Primera Casa</button></div>`;
                    return;
                }

                let html = '<table style="width:100%; border-collapse: collapse; text-align: left;"><thead><tr style="border-bottom: 2px solid #e2e8f0; background: #f8fafc;"><th style="padding:15px; color: #64748b; font-weight: 600;">Imagen</th><th style="padding:15px; color: #64748b; font-weight: 600;">T√≠tulo</th><th style="padding:15px; color: #64748b; font-weight: 600;">Precio</th><th style="padding:15px; color: #64748b; font-weight: 600;">Estado</th><th style="padding:15px; color: #64748b; font-weight: 600;">Acciones</th></tr></thead><tbody>';

                snapshot.forEach(doc => {
                    const house = doc.data();
                    const img = Array.isArray(house.images) ? house.images[0] : (house.image || 'https://via.placeholder.com/100');

                    html += `
                        <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.2s;">
                            <td style="padding:15px;"><img src="${img}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 6px;"></td>
                            <td style="padding:15px; font-weight:500; color: #334155;">${house.title}</td>
                            <td style="padding:15px; color: var(--primary); font-weight:600;">${parseInt(house.price).toLocaleString()}‚Ç¨</td>
                            <td style="padding:15px;"><span style="background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">Activa</span></td>
                            <td style="padding:15px;">
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="openEditHouseModal('${doc.id}')" class="btn-dash btn-dash-outline" style="padding: 6px 12px; flex: 0;"><i class="fa-solid fa-pen"></i></button>
                                    <button onclick="deleteHouse('${doc.id}')" class="btn-dash btn-dash-outline" style="padding: 6px 12px; flex: 0; color: #ef4444; border-color: #fee2e2; background: #fef2f2;"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Error loading inventory:', error);

                // Si falla el orderBy, intentar sin √©l
                if (error.code === 'failed-precondition') {
                    // Fallback...
                }

                container.innerHTML = '<p class="empty-dashboard" style="color:red;">Error al cargar inventario (posiblemente falta de √≠ndice).</p>';
            }
        }

        let currentEditingHouseId = null;

        async function openEditHouseModal(houseId) {
            currentEditingHouseId = houseId;
            try {
                const doc = await db.collection('houses').doc(houseId).get();
                const house = doc.data();

                document.getElementById('editHouseId').value = houseId;
                document.getElementById('editHouseTitle').value = house.title;
                document.getElementById('editHousePrice').value = house.price;
                document.getElementById('editHouseArea').value = house.area;
                document.getElementById('editHouseImage').value = Array.isArray(house.images) ? house.images[0] : house.image;
                document.getElementById('editHouseDesc').value = house.description || '';

                document.getElementById('editHouseModal').style.display = 'flex';
            } catch (error) {
                console.error('Error fetching house details:', error);
                alert('Error al cargar detalles de la casa');
            }
        }

        function closeEditHouseModal() {
            document.getElementById('editHouseModal').style.display = 'none';
            currentEditingHouseId = null;
        }

        async function handleUpdateHouse(e) {
            e.preventDefault();
            if (!currentEditingHouseId) return;

            const updates = {
                title: document.getElementById('editHouseTitle').value,
                price: Number(document.getElementById('editHousePrice').value),
                area: Number(document.getElementById('editHouseArea').value),
                images: [document.getElementById('editHouseImage').value], // Store as array
                description: document.getElementById('editHouseDesc').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('houses').doc(currentEditingHouseId).update(updates);
                showToast('Propiedad actualizada', 'success');
                closeEditHouseModal();
                loadInventory();
            } catch (error) {
                console.error('Error updating house:', error);
                showToast('Error al actualizar propiedad', 'error');
            }
        }

        async function deleteHouse(houseId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta casa? Esta acci√≥n no se puede deshacer.')) return;

            try {
                await db.collection('houses').doc(houseId).delete();
                loadInventory();
            } catch (error) {
                console.error('Error deleting house:', error);
                showToast('Error al eliminar casa', 'error');
            }
        }

        // Get status text
        function getStatusText(status) {
            switch (status) {
                case 'approved': return '‚úÖ Aprobada';
                case 'rejected': return '‚ùå Rechazada';
                case 'pending':
                default: return 'üü° Pendiente de aprobaci√≥n';
            }
        }

        // Show status banner
        function showStatusBanner(status) {
            const banner = document.getElementById('statusBanner');

            if (status === 'pending') {
                banner.innerHTML = `
                    <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                        <h3 style="color: #92400e; margin-top: 0; margin-bottom: 10px; font-size: 1.1rem;">
                            <i class="fa-solid fa-clock"></i> Cuenta en Revisi√≥n
                        </h3>
                        <p style="color: #b45309; margin: 0; line-height: 1.5; font-size: 0.95rem;">
                            Tu solicitud est√° siendo revisada. Podr√°s publicar casas una vez sea aprobada.
                        </p>
                    </div>
                `;
                banner.style.display = 'block';

            } else if (status === 'rejected') {
                banner.innerHTML = `
                   <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="color: #991b1b; margin-top: 0; margin-bottom: 10px; font-size: 1.1rem;">
                            <i class="fa-solid fa-circle-xmark"></i> Solicitud Rechazada
                        </h3>
                        <p style="color: #b91c1c; margin: 0; line-height: 1.5; font-size: 0.95rem;">
                           Contacta con soporte para m√°s informaci√≥n.
                        </p>
                    </div>
                `;
                banner.style.display = 'block';

            } else if (status === 'approved') {
                banner.style.display = 'none';
            }
        }

        // Verificar email
        async function verifyEmail() {
            try {
                await currentUser.sendEmailVerification();
                alert('‚úÖ Email de verificaci√≥n enviado! Revisa tu bandeja de entrada.');
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al enviar email: ' + error.message);
            }
        }

        function openComingSoonModal(featureName) {
            document.getElementById('comingSoonFeature').textContent = featureName || 'esta funci√≥n';
            document.getElementById('comingSoonModal').style.display = 'flex';
        }

        // Cargar leads recibidos (Chat Style)
        async function loadLeads() {
            const leadsList = document.getElementById('leadsList');
            try {
                const snapshot = await db.collection('leads')
                    .where('companyId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    leadsList.innerHTML = `
                        <div class="empty-dashboard">
                            <i class="fa-solid fa-comments" style="font-size: 2rem; color: #cbd5e1; margin-bottom: 15px;"></i>
                            <p>No tienes mensajes nuevos.</p>
                        </div>
                    `;
                    return;
                }

                let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';

                snapshot.forEach(doc => {
                    const lead = doc.data();
                    const date = lead.createdAt?.toDate().toLocaleDateString('es-ES') || 'Reciente';
                    const isNew = lead.status === 'new';

                    html += `
                        <div style="background: ${isNew ? '#f0fdf4' : 'white'}; padding: 20px; border-radius: 12px; border: 1px solid ${isNew ? '#bbf7d0' : '#e2e8f0'}; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div style="width: 40px; height: 40px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #64748b;">
                                        <i class="fa-solid fa-user"></i>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; color: #0f172a; font-size: 0.95rem;">${lead.userName}</h4>
                                        <span style="font-size: 0.8rem; color: #64748b;">Interesado en <strong>${lead.houseTitle}</strong></span>
                                    </div>
                                </div>
                                <span style="font-size: 0.8rem; color: #94a3b8;">${date}</span>
                            </div>
                            
                            <p style="margin: 0 0 15px 52px; color: #334155; font-size: 0.95rem; line-height: 1.5;">"${lead.message}"</p>

                            <div style="display: flex; justify-content: flex-end; gap: 10px; padding-left: 52px;">
                                <a href="mailto:${lead.userEmail}" class="btn-dash btn-dash-outline btn-sm" onclick="updateLeadStatus('${doc.id}', 'contacted')">
                                    <i class="fa-solid fa-reply"></i> Responder Email
                                </a>
                                <button onclick="openComingSoonModal('Chat en Vivo')" class="btn-dash btn-dash-primary btn-sm">
                                    <i class="fa-solid fa-comment-dots"></i> Chat
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                leadsList.innerHTML = html;

            } catch (error) {
                console.error('Error loading leads:', error);
                leadsList.innerHTML = '<p class="empty-dashboard" style="color: #ef4444;">Error al cargar mensajes</p>';
            }
        }

        async function updateLeadStatus(leadId, newStatus) {
            try {
                await db.collection('leads').doc(leadId).update({ status: newStatus });
                // We reload silently to update UI state if needed, or just let it be
                if (newStatus === 'archived') loadLeads();
            } catch (error) {
                console.error('Error updating lead status:', error);
            }
        }

        // Load Analytics
        async function loadAnalytics() {
            // Simplified analytics placeholder logic if needed
        }

        // Cerrar sesi√≥n
        async function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                await auth.signOut();
                window.location.href = 'index.html';
            }
        }
    </script>
</body>

</html>
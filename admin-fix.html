<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Admin Fix Tool</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .log {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }

        .btn {
            padding: 10px 20px;
            cursor: pointer;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
        }
    </style>
</head>

<body>
    <h1>üõ† Herramienta de Reparaci√≥n y Diagn√≥stico</h1>
    <p>Esta herramienta verificar√° y reparar√° los datos cr√≠ticos del sistema.</p>

    <button onclick="runDiagnostics()" class="btn">Ejecutar Diagn√≥stico y Reparaci√≥n</button>

    <div id="console" class="log">Esperando inicio...</div>

    <script>
        const logDiv = document.getElementById('console');
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            if (type === 'success') div.style.color = 'green';
            if (type === 'error') div.style.color = 'red';
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        const housesToFix = [
            {
                id: 'house_nordic',
                data: {
                    title: 'Modelo Nordic Eco',
                    price: 45000,
                    area: 80,
                    bedrooms: 2,
                    bathrooms: 1,
                    deliveryTime: '2 Meses',
                    category: 'madera',
                    images: ['https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&w=1200&q=80'],
                    description: 'Vivienda sostenible inspirada en el dise√±o escandinavo.',
                    companyId: 'DEMO_COMPANY'
                }
            },
            {
                id: 'house_villa',
                data: {
                    title: 'Villa Modular Premium',
                    price: 120000,
                    area: 150,
                    bedrooms: 4,
                    bathrooms: 2,
                    deliveryTime: '4 Meses',
                    category: 'hormigon',
                    images: ['https://images.unsplash.com/photo-1600596542815-22b4899975d6?auto=format&fit=crop&w=1200&q=80'],
                    description: 'Lujo prefabricado con acabados de hormig√≥n arquitect√≥nico.',
                    companyId: 'DEMO_COMPANY'
                }
            },
            {
                id: 'house_wood',
                data: {
                    title: 'Caba√±a Prefabricada Wood',
                    price: 35000,
                    area: 60,
                    bedrooms: 2,
                    bathrooms: 1,
                    deliveryTime: '1.5 Meses',
                    category: 'madera',
                    images: ['https://images.unsplash.com/photo-1582268611958-ebfd161ef9cf?auto=format&fit=crop&w=1200&q=80'],
                    description: 'Refugio c√°lido y acogedor, ideal para fincas rurales.',
                    companyId: 'DEMO_COMPANY'
                }
            },
            {
                id: 'house_granito',
                data: {
                    title: 'Modelo Granito',
                    price: 70000, // Estimado segun cat√°logo
                    area: 70,
                    bedrooms: 3,
                    bathrooms: 1,
                    deliveryTime: '3 Meses',
                    category: 'hormigon',
                    images: ['images/houses/granito/main.png'], // Ojo con ruta relativa, idealmente url absoluta
                    description: 'Solidez y dise√±o compacto en hormig√≥n.',
                    companyId: 'DEMO_COMPANY'
                }
            },
            {
                id: 'house_horizon',
                data: {
                    title: 'Modelo Horizon',
                    price: 89000,
                    area: 120,
                    bedrooms: 3,
                    bathrooms: 2,
                    deliveryTime: '4 Meses',
                    category: 'acero',
                    images: ['https://images.unsplash.com/photo-1564013799919-ab600027ffc6?auto=format&fit=crop&w=1200&q=80'],
                    description: 'Dise√±o vanguardista con estructura de acero ligero.',
                    companyId: 'DEMO_COMPANY'
                }
            },
            {
                id: 'house_tiny',
                data: {
                    title: 'Tiny House Mobile',
                    price: 25000,
                    area: 30,
                    bedrooms: 1,
                    bathrooms: 1,
                    deliveryTime: '1 Mes',
                    category: 'movil',
                    images: ['https://images.unsplash.com/photo-1625573134318-c583c18e3c64?auto=format&fit=crop&w=1200&q=80'],
                    description: 'Libertad total. Tu casa donde t√∫ quieras.',
                    companyId: 'DEMO_COMPANY'
                }
            },
            {
                id: 'house_elite',
                data: {
                    title: 'Residencia Elite',
                    price: 150000,
                    area: 200,
                    bedrooms: 5,
                    bathrooms: 3,
                    deliveryTime: '6 Meses',
                    category: 'hormigon',
                    images: ['https://images.unsplash.com/photo-1605276374104-dee2a0ed3cd6?auto=format&fit=crop&w=1200&q=80'],
                    description: 'M√°xima exclusividad y espacio para toda la familia.',
                    companyId: 'DEMO_COMPANY'
                }
            }
        ];

        async function runDiagnostics() {
            log('Iniciando diagn√≥stico...', 'info');

            // 1. Check Auth
            log('Verificando autenticaci√≥n...', 'info');
            const user = firebase.auth().currentUser;
            if (user) {
                log(`Usuario autenticado: ${user.email}`, 'success');
            } else {
                log('Usuario no autenticado (ejecutando como an√≥nimo/p√∫blico)', 'info');
            }

            // 2. Fix Houses
            log('Verificando cat√°logo de casas...', 'info');
            for (const house of housesToFix) {
                try {
                    const docRef = db.collection('houses').doc(house.id);
                    const doc = await docRef.get();

                    if (!doc.exists) {
                        log(`Casa ${house.id} no existe. Creando...`, 'info');
                        await docRef.set({
                            ...house.data,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        log(`‚úÖ Casa ${house.id} creada correctamente.`, 'success');
                    } else {
                        log(`Casa ${house.id} ya existe. Actualizando datos cr√≠ticos...`, 'info');
                        await docRef.update({
                            ...house.data,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        log(`‚úÖ Casa ${house.id} actualizada.`, 'success');
                    }
                } catch (e) {
                    log(`‚ùå Error con casa ${house.id}: ${e.message}`, 'error');
                }
            }

            // 3. Test Ticket System
            log('Probando sistema de tickets (Leads)...', 'info');
            try {
                await db.collection('leads').add({
                    type: 'system_test',
                    message: 'Test de diagn√≥stico autom√°tico',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    houseId: 'SYSTEM_TEST'
                });
                log('‚úÖ Escritura en colecci√≥n LEADS correcta.', 'success');
            } catch (e) {
                log(`‚ùå Error escribiendo en LEADS: ${e.message}`, 'error');
            }

            log('--- Diagn√≥stico Finalizado ---', 'info');
            log('Si todo est√° en verde, el sistema est√° listo.', 'success');
        }
    </script>
</body>

</html>
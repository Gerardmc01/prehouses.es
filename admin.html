<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración | Prehouses</title>
    <!-- Dependencies -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="icon" type="image/png" href="favicon_prehouses_1764872622091.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* Admin Specific Overrides */
        .admin-sidebar {
            background-color: #0f172a !important;
            /* Slate 900 */
        }

        .dash-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 3px solid #f43f5e;
            /* Rose 500 accent */
        }

        .dash-link:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .stat-icon.rose {
            background: #ffe4e6;
            color: #e11d48;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-pending {
            background: #fff7ed;
            color: #c2410c;
            border: 1px solid #ffedd5;
        }

        .badge-approved {
            background: #f0fdf4;
            color: #15803d;
            border: 1px solid #dcfce7;
        }

        .badge-rejected {
            background: #fef2f2;
            color: #b91c1c;
            border: 1px solid #fee2e2;
        }

        .badge-nuevo {
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #dbeafe;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Table Actions */
        .btn-icon {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .btn-icon.delete {
            color: #ef4444;
            border-color: #fee2e2;
            background: #fef2f2;
        }

        .btn-icon.delete:hover {
            background: #fee2e2;
            border-color: #fecaca;
        }

        .btn-icon.approve {
            color: #10b981;
            border-color: #d1fae5;
            background: #ecfdf5;
        }

        .btn-icon.approve:hover {
            background: #d1fae5;
        }
    </style>
</head>

<body>

    <div class="dashboard-layout">
        <!-- SIDEBAR -->
        <aside class="dash-sidebar admin-sidebar">
            <a href="index.html" class="dash-logo">
                <i class="fa-solid fa-shield-halved"></i>
                <span>Prehouses<small
                        style="font-size: 0.7rem; display: block; opacity: 0.6; font-weight: 400;">ADMINISTRATION</small></span>
            </a>

            <div class="user-profile-mini">
                <div class="user-avatar" style="background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);">
                    <i class="fa-solid fa-user-shield"></i>
                </div>
                <div class="user-info-mini">
                    <h4>Admin System</h4>
                    <p>Superuser</p>
                </div>
            </div>

            <nav class="dash-nav">
                <a href="#" class="dash-link active" onclick="switchTab('dashboard', this)">
                    <i class="fa-solid fa-gauge-high"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="dash-link" onclick="switchTab('companies', this)">
                    <i class="fa-solid fa-building"></i>
                    <span>Empresas</span>
                </a>
                <a href="#" class="dash-link" onclick="switchTab('users', this)">
                    <i class="fa-solid fa-users"></i>
                    <span>Usuarios</span>
                </a>
                <a href="#" class="dash-link" onclick="switchTab('houses', this)">
                    <i class="fa-solid fa-home"></i>
                    <span>Catálogo</span>
                </a>
                <a href="#" class="dash-link" onclick="switchTab('leads', this)">
                    <i class="fa-solid fa-envelope-open-text"></i>
                    <span>Leads</span>
                </a>
                <a href="#" class="dash-link" onclick="switchTab('blog', this)">
                    <i class="fa-solid fa-newspaper"></i>
                    <span>Blog & SEO</span>
                </a>
                <a href="#" class="dash-link" onclick="switchTab('tickets', this)">
                    <i class="fa-solid fa-headset"></i>
                    <span>Soporte</span>
                </a>

                <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <a href="#" class="dash-link" onclick="fixAdminPermissions()">
                        <i class="fa-solid fa-wrench"></i>
                        <span>Reparar Root</span>
                    </a>
                    <a href="#" onclick="logout()" class="dash-link logout">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <span>Cerrar Sesión</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="dash-main">
            <header class="dash-header">
                <div class="dash-title">
                    <div class="breadcrumb">Sistema de Administración</div>
                    <h1 id="pageTitle">Panel Principal</h1>
                </div>
                <div class="dash-actions">
                    <span
                        style="font-size: 0.9rem; color: #64748b; background: #f1f5f9; padding: 5px 12px; border-radius: 8px;">
                        <i class="fa-solid fa-server"></i> v2.0.0
                    </span>
                </div>
            </header>

            <!-- TAB: DASHBOARD (Overview) -->
            <div id="tab-dashboard" class="tab-content active">
                <div class="dash-grid-stats">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon blue">
                                <i class="fa-solid fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Usuarios Reg.</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green">
                                <i class="fa-solid fa-building"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalCompanies">0</div>
                        <div class="stat-label">Empresas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon purple">
                                <i class="fa-solid fa-home"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalHouses">0</div>
                        <div class="stat-label">Casas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon rose">
                                <i class="fa-solid fa-envelope"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalLeads">0</div>
                        <div class="stat-label">Leads Totales</div>
                    </div>
                </div>

                <div class="section-header" style="margin-top: 40px;">
                    <h2>Actividad Reciente</h2>
                </div>
                <div
                    style="background: white; padding: 30px; border-radius: 16px; border: 1px solid #e2e8f0; text-align: center; color: #94a3b8;">
                    <i class="fa-solid fa-chart-line" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                    <p>La vista general de actividad se está implementando.</p>
                    <button onclick="switchTab('companies', document.querySelectorAll('.dash-link')[1])"
                        class="btn-dash btn-dash-primary" style="margin-top: 15px;">Gestionar Empresas</button>
                </div>
            </div>

            <!-- TAB: EMPRESAS -->
            <div id="tab-companies" class="tab-content">
                <div class="section-header">
                    <h2>Gestión de Empresas</h2>
                    <button onclick="loadCompanies()" class="btn-dash btn-dash-outline btn-sm"><i
                            class="fa-solid fa-rotate"></i></button>
                </div>
                <div class="dashboard-card" style="padding: 0; overflow: hidden;">
                    <div id="companiesList">
                        <div class="empty-dashboard">
                            <p>Cargando empresas...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: USUARIOS -->
            <div id="tab-users" class="tab-content">
                <div class="section-header">
                    <h2>Gestión de Usuarios</h2>
                    <button onclick="loadUsers()" class="btn-dash btn-dash-outline btn-sm"><i
                            class="fa-solid fa-rotate"></i></button>
                </div>
                <div class="dashboard-card" style="padding: 0; overflow: hidden;">
                    <div id="usersList">
                        <div class="empty-dashboard">
                            <p>Cargando usuarios...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: CASAS -->
            <div id="tab-houses" class="tab-content">
                <div class="section-header">
                    <h2>Catálogo Global</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="initializeCatalog()" class="btn-dash btn-dash-outline btn-sm">
                            <i class="fa-solid fa-cloud-arrow-up"></i> Importar Demo
                        </button>
                        <button onclick="loadHouses()" class="btn-dash btn-dash-outline btn-sm"><i
                                class="fa-solid fa-rotate"></i></button>
                    </div>
                </div>
                <div class="dashboard-card" style="padding: 0; overflow: hidden;">
                    <div id="housesList">
                        <div class="empty-dashboard">
                            <p>Cargando catálogo...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: LEADS -->
            <div id="tab-leads" class="tab-content">
                <div class="section-header">
                    <h2>Todos los Leads</h2>
                    <button onclick="loadLeads()" class="btn-dash btn-dash-outline btn-sm"><i
                            class="fa-solid fa-rotate"></i></button>
                </div>
                <div class="dashboard-card" style="padding: 0; overflow: hidden;">
                    <div id="leadsList">
                        <div class="empty-dashboard">
                            <p>Cargando leads...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: BLOG & SEO -->
            <div id="tab-blog" class="tab-content">
                <div class="section-header">
                    <h2>Contenido & SEO</h2>
                    <button onclick="openPostModal()" class="btn-dash btn-dash-primary">
                        <i class="fa-solid fa-plus"></i> Nuevo Artículo
                    </button>
                </div>

                <div class="dashboard-card" style="padding: 0; overflow: hidden; margin-bottom: 30px;">
                    <div id="blogList">
                        <div class="empty-dashboard">
                            <p>Cargando artículos...</p>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3><i class="fa-solid fa-sitemap"></i> Generador de Sitemap XML</h3>
                    <p style="color: #64748b; margin-bottom: 15px; font-size: 0.9rem;">Actualiza el sitemap.xml con las
                        últimas casas y posts.</p>
                    <button onclick="generateSitemap()" class="btn-dash btn-dash-outline btn-sm"
                        style="margin-bottom: 15px;">
                        Generar XML
                    </button>
                    <textarea id="sitemapOutput" rows="8"
                        style="width: 100%; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: monospace; font-size: 0.8rem; background: #f8fafc;"
                        readonly placeholder="El XML aparecerá aquí..."></textarea>
                </div>
            </div>

            <!-- TAB: TICKETS -->
            <div id="tab-tickets" class="tab-content">
                <div class="section-header">
                    <h2>Soporte & Tickets</h2>
                    <button onclick="loadTickets()" class="btn-dash btn-dash-outline btn-sm"><i
                            class="fa-solid fa-rotate"></i></button>
                </div>
                <div class="dashboard-card" style="padding: 0; overflow: hidden;">
                    <div id="ticketsList">
                        <div class="empty-dashboard">
                            <p>Cargando tickets...</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Edit/Create Post Modal -->
    <div id="postModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1200; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative;">
            <span onclick="closePostModal()"
                style="position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 1.5rem;">&times;</span>
            <h2 id="postModalTitle" style="margin-bottom: 20px;">Escribir Artículo</h2>
            <form id="postForm" onsubmit="handleSavePost(event)">
                <input type="hidden" id="postId">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Título</label>
                    <input type="text" id="postTitle" required
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Imagen de Portada (URL)</label>
                    <input type="url" id="postImage" required
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Resumen (Extracto)</label>
                    <textarea id="postExcerpt" rows="3" required
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Contenido Completo (HTML
                        permitido)</label>
                    <textarea id="postContent" rows="10" required
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: monospace;"></textarea>
                </div>
                <button type="submit" class="btn-dash btn-dash-primary" style="width: 100%;">Publicar Artículo</button>
            </form>
        </div>
    </div>

    <!-- Edit House Modal -->
    <div id="editHouseModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1200; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative;">
            <span onclick="closeEditModal()"
                style="position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 1.5rem;">&times;</span>
            <h2 style="margin-bottom: 20px;">Editar Casa</h2>
            <form id="editHouseForm" onsubmit="handleEditHouse(event)">
                <input type="hidden" id="editHouseId">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Título</label>
                    <input type="text" id="editTitle" required
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Precio (€)</label>
                    <input type="number" id="editPrice" required
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Descripción</label>
                    <textarea id="editDescription" rows="4"
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Imagen URL</label>
                    <input type="url" id="editImage"
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" onclick="closeEditModal()" class="btn-dash btn-dash-outline">Cancelar</button>
                    <button type="submit" class="btn-dash btn-dash-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/support.js"></script> <!-- Assuming this has some generic utilities -->

    <script>
        const ADMIN_EMAIL = 'prehouses24h@gmail.com';
        let currentUser = null;

        // --- AUTH & INIT ---
        auth.onAuthStateChanged(async (user) => {
            let isAdmin = false;

            if (user) {
                if (user.email === ADMIN_EMAIL) isAdmin = true;
                else {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (doc.exists && doc.data().userType === 'admin') isAdmin = true;
                }
            }

            if (!isAdmin) {
                // Not authorized layout
                document.body.innerHTML = `
                   <div style="height: 100vh; display: flex; align-items: center; justify-content: center; background: #f1f5f9; font-family: 'Outfit', sans-serif;">
                        <div style="background: white; padding: 50px; border-radius: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 400px;">
                            <div style="width: 80px; height: 80px; background: #fee2e2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                                <i class="fa-solid fa-lock" style="font-size: 2.5rem; color: #ef4444;"></i>
                            </div>
                            <h2 style="color: #0f172a; margin-bottom: 10px;">Acceso Restringido</h2>
                            <p style="color: #64748b; margin-bottom: 25px;">Esta área es exclusiva para administradores del sistema.</p>
                            <a href="index.html" style="background: #0f172a; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 500; display: inline-block;">Volver al Inicio</a>
                        </div>
                    </div>
                `;
                return;
            }

            currentUser = user;
            loadStats(); // Only load stats initially
            // Tabs load data when clicked
        });

        // --- NAVIGATION TABS ---
        function switchTab(tabName, linkElement) {
            // Update sidebar active state
            if (linkElement) {
                document.querySelectorAll('.dash-nav .dash-link').forEach(l => l.classList.remove('active'));
                linkElement.classList.add('active');
            }

            // Show tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');

            // Update Header Title
            const titles = {
                'dashboard': 'Panel Principal',
                'companies': 'Gestión de Empresas',
                'users': 'Gestión de Usuarios',
                'houses': 'Catálogo Global',
                'leads': 'Gestión de Leads',
                'blog': 'Blog & SEO',
                'tickets': 'Soporte Técnico'
            };
            document.getElementById('pageTitle').textContent = titles[tabName] || 'Admin Panel';

            // Lazy Load Data
            if (tabName === 'companies') loadCompanies();
            if (tabName === 'users') loadUsers();
            if (tabName === 'houses') loadHouses();
            if (tabName === 'leads') loadLeads();
            if (tabName === 'blog') loadPosts();
            if (tabName === 'tickets') loadTickets();
            if (tabName === 'dashboard') loadStats();
        }

        // --- DATA LOADING & RENDERING ---

        async function loadCompanies() {
            const container = document.getElementById('companiesList');
            container.innerHTML = '<div class="empty-dashboard"><i class="fa-solid fa-spinner fa-spin"></i><p>Cargando...</p></div>';

            try {
                const snapshot = await db.collection('users').where('userType', '==', 'empresa').get();

                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-dashboard"><p>No hay empresas registradas.</p></div>';
                    return;
                }

                let html = '<table style="width:100%; border-collapse: collapse; text-align: left;"><thead><tr style="border-bottom: 2px solid #e2e8f0; background: #f8fafc;"><th style="padding:15px; color: #64748b;">Empresa</th><th style="padding:15px; color: #64748b;">Email</th><th style="padding:15px; color: #64748b;">Estado</th><th style="padding:15px; color: #64748b;">Fecha</th><th style="padding:15px; color: #64748b;">Acciones</th></tr></thead><tbody>';

                snapshot.forEach(doc => {
                    const company = doc.data();
                    const status = company.status || 'pending';
                    const badgeClass = status === 'approved' ? 'badge-approved' : status === 'rejected' ? 'badge-rejected' : 'badge-pending';
                    const date = company.createdAt?.toDate().toLocaleDateString('es-ES') || 'N/A';

                    html += `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding:15px; font-weight: 500;">${company.name || 'Sin nombre'}</td>
                            <td style="padding:15px; color: #64748b; font-size: 0.9rem;">${company.email || doc.id}</td>
                            <td style="padding:15px;"><span class="badge ${badgeClass}">${status}</span></td>
                            <td style="padding:15px; color: #64748b; font-size: 0.9rem;">${date}</td>
                            <td style="padding:15px;">
                                <div style="display: flex; gap: 5px;">
                                    ${status !== 'approved' ? `<button class="btn-icon approve" title="Aprobar" onclick="updateCompanyStatus('${doc.id}', 'approved')"><i class="fa-solid fa-check"></i></button>` : ''}
                                    ${status !== 'rejected' ? `<button class="btn-icon delete" title="Rechazar" onclick="updateCompanyStatus('${doc.id}', 'rejected')"><i class="fa-solid fa-xmark"></i></button>` : ''}
                                    <button class="btn-icon delete" title="Eliminar" onclick="deleteUser('${doc.id}')"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading companies:', error);

                // Hack: if index missing, try client side filter or just show error, but we need to proceed
                container.innerHTML = '<p class="empty-dashboard" style="color:red;">Error cargando empresas (check console)</p>';
            }
        }

        async function loadUsers() {
            const container = document.getElementById('usersList');
            container.innerHTML = '<div class="empty-dashboard"><i class="fa-solid fa-spinner fa-spin"></i><p>Cargando...</p></div>';

            try {
                const snapshot = await db.collection('users').get();
                const users = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    if (d.userType !== 'empresa') users.push({ id: doc.id, ...d });
                });

                if (users.length === 0) {
                    container.innerHTML = '<div class="empty-dashboard"><p>No hay usuarios registrados.</p></div>';
                    return;
                }

                let html = '<table style="width:100%; border-collapse: collapse; text-align: left;"><thead><tr style="border-bottom: 2px solid #e2e8f0; background: #f8fafc;"><th style="padding:15px; color: #64748b;">Usuario</th><th style="padding:15px; color: #64748b;">Email</th><th style="padding:15px; color: #64748b;">Fecha</th><th style="padding:15px; color: #64748b;">Acciones</th></tr></thead><tbody>';

                users.forEach(user => {
                    const date = user.createdAt?.toDate().toLocaleDateString('es-ES') || 'N/A';
                    html += `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding:15px; font-weight: 500;">${user.name || 'Sin nombre'}</td>
                            <td style="padding:15px; color: #64748b; font-size: 0.9rem;">${user.email || user.id}</td>
                            <td style="padding:15px; color: #64748b; font-size: 0.9rem;">${date}</td>
                            <td style="padding:15px;">
                                <button class="btn-icon delete" onclick="deleteUser('${user.id}')"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error(error);
                container.innerHTML = '<p class="empty-dashboard">Error</p>';
            }
        }

        async function loadHouses() {
            const container = document.getElementById('housesList');
            container.innerHTML = '<div class="empty-dashboard"><i class="fa-solid fa-spinner fa-spin"></i><p>Cargando...</p></div>';

            try {
                const snapshot = await db.collection('houses').orderBy('createdAt', 'desc').get();

                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-dashboard"><p>No hay casas publicadas.</p></div>';
                    return;
                }

                let html = '<table style="width:100%; border-collapse: collapse; text-align: left;"><thead><tr style="border-bottom: 2px solid #e2e8f0; background: #f8fafc;"><th style="padding:15px; color: #64748b;">Propiedad</th><th style="padding:15px; color: #64748b;">Precio</th><th style="padding:15px; color: #64748b;">Empresa</th><th style="padding:15px; color: #64748b;">Fecha</th><th style="padding:15px; color: #64748b;">Acciones</th></tr></thead><tbody>';

                snapshot.forEach(doc => {
                    const house = doc.data();
                    const date = house.createdAt?.toDate().toLocaleDateString('es-ES') || 'N/A';

                    html += `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding:15px; font-weight: 500;">${house.title}</td>
                            <td style="padding:15px; color: var(--primary); font-weight: 600;">${house.price}€</td>
                            <td style="padding:15px; color: #64748b; font-size: 0.9rem;">${house.companyName || 'N/A'}</td>
                            <td style="padding:15px; color: #64748b; font-size: 0.9rem;">${date}</td>
                            <td style="padding:15px;">
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn-icon" onclick="openEditModal('${doc.id}')"><i class="fa-solid fa-pen"></i></button>
                                    <button class="btn-icon delete" onclick="deleteHouse('${doc.id}')"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error(error);
                if (error.code === 'failed-precondition') {
                    container.innerHTML = '<p class="empty-dashboard">Falta índice Firestore para ordenar casas.</p>';
                } else {
                    container.innerHTML = '<p class="empty-dashboard">Error cargando casas.</p>';
                }
            }
        }

        async function loadLeads() {
            const container = document.getElementById('leadsList');
            container.innerHTML = '<div class="empty-dashboard"><i class="fa-solid fa-spinner fa-spin"></i><p>Cargando...</p></div>';
            try {
                const snapshot = await db.collection('leads').orderBy('createdAt', 'desc').limit(50).get();
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-dashboard"><p>No hay leads.</p></div>';
                    return;
                }

                let html = '<table style="width:100%; border-collapse: collapse; text-align: left;"><thead><tr style="border-bottom: 2px solid #e2e8f0; background: #f8fafc;"><th style="padding:15px; color: #64748b;">Usuario</th><th style="padding:15px; color: #64748b;">Interés</th><th style="padding:15px; color: #64748b;">Estado</th><th style="padding:15px; color: #64748b;">Fecha</th></tr></thead><tbody>';

                snapshot.forEach(doc => {
                    const lead = doc.data();
                    const date = lead.createdAt?.toDate().toLocaleDateString('es-ES') || 'N/A';
                    const badge = lead.status === 'new' ? 'badge-nuevo' : 'badge-approved';

                    html += `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding:15px;">
                                <div style="font-weight: 500;">${lead.userName}</div>
                                <div style="font-size: 0.8rem; color: #64748b;">${lead.userEmail}</div>
                            </td>
                            <td style="padding:15px; color: #334155;">${lead.houseTitle || 'N/A'}</td>
                            <td style="padding:15px;"><span class="badge ${badge}">${lead.status}</span></td>
                            <td style="padding:15px; color: #64748b; font-size: 0.9rem;">${date}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (e) {
                console.error(e);
                container.innerHTML = '<p class="empty-dashboard">Error</p>';
            }
        }

        async function loadPosts() {
            const container = document.getElementById('blogList');
            container.innerHTML = '<div class="empty-dashboard"><i class="fa-solid fa-spinner fa-spin"></i><p>Cargando posts...</p></div>';
            try {
                const snapshot = await db.collection('posts').orderBy('createdAt', 'desc').get();
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-dashboard"><p>No hay posts.</p></div>';
                    return;
                }

                let html = '<table style="width:100%; border-collapse: collapse; text-align: left;"><thead><tr style="border-bottom: 2px solid #e2e8f0; background: #f8fafc;"><th style="padding:15px; color: #64748b;">Portada</th><th style="padding:15px; color: #64748b;">Título</th><th style="padding:15px; color: #64748b;">Fecha</th><th style="padding:15px; color: #64748b;">Acciones</th></tr></thead><tbody>';

                snapshot.forEach(doc => {
                    const post = doc.data();
                    html += `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding:15px;"><img src="${post.image}" style="width:50px; height:35px; object-fit:cover; border-radius:4px;"></td>
                            <td style="padding:15px; font-weight:500;">${post.title}</td>
                            <td style="padding:15px; font-size:0.9rem; color:#64748b;">${post.createdAt?.toDate().toLocaleDateString('es-ES') || 'N/A'}</td>
                            <td style="padding:15px;"><button class="btn-icon delete" onclick="deletePost('${doc.id}')"><i class="fa-solid fa-trash"></i></button></td>
                        </tr>
                   `;
                });
                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (e) {
                console.error(e);
                container.innerHTML = '<p class="empty-dashboard">Error loading posts</p>';
            }
        }

        async function loadTickets() {
            const container = document.getElementById('ticketsList');
            container.innerHTML = '<div class="empty-dashboard"><p>No hay tickets implementados.</p></div>';
            // Placeholder implementation
        }

        async function loadStats() {
            try {
                // Approximate counts (real app should use aggregation or counters)
                const usersSnap = await db.collection('users').get();
                const housesSnap = await db.collection('houses').get();
                const leadsSnap = await db.collection('leads').get();

                let companiesCount = 0;
                usersSnap.forEach(doc => { if (doc.data().userType === 'empresa') companiesCount++; });

                document.getElementById('totalUsers').textContent = usersSnap.size;
                document.getElementById('totalCompanies').textContent = companiesCount;
                document.getElementById('totalHouses').textContent = housesSnap.size;
                document.getElementById('totalLeads').textContent = leadsSnap.size;

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // --- ACTIONS ---

        async function updateCompanyStatus(id, status) {
            if (!confirm(`¿Confirmar ${status}?`)) return;
            await db.collection('users').doc(id).update({ status: status });
            loadCompanies();
        }

        async function deleteUser(id) {
            if (!confirm('¿Eliminar usuario Permanentemente?')) return;
            await db.collection('users').doc(id).delete();
            loadUsers();
            loadCompanies();
        }

        async function deleteHouse(id) {
            if (!confirm('¿Eliminar casa?')) return;
            await db.collection('houses').doc(id).delete();
            loadHouses();
        }

        async function deletePost(id) {
            if (!confirm('¿Eliminar post?')) return;
            await db.collection('posts').doc(id).delete();
            loadPosts();
        }

        async function fixAdminPermissions() {
            if (!currentUser) return;
            await db.collection('users').doc(currentUser.uid).update({
                userType: 'admin',
                role: 'admin'
            });
            alert('Permisos de usuario actual reparados a ADMIN.');
            location.reload();
        }

        // --- BLOG MODAL ---
        function openPostModal() {
            document.getElementById('postForm').reset();
            document.getElementById('postId').value = '';
            document.getElementById('postModal').style.display = 'flex';
        }
        function closePostModal() {
            document.getElementById('postModal').style.display = 'none';
        }
        async function handleSavePost(e) {
            e.preventDefault();
            const id = document.getElementById('postId').value;
            const data = {
                title: document.getElementById('postTitle').value,
                image: document.getElementById('postImage').value,
                excerpt: document.getElementById('postExcerpt').value,
                content: document.getElementById('postContent').value,
                author: 'Admin',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            if (id) await db.collection('posts').doc(id).update(data);
            else await db.collection('posts').add(data);

            closePostModal();
            loadPosts();
            alert('Post guardado');
        }

        // --- HOUSE EDIT MODAL ---
        async function openEditModal(houseId) {
            const doc = await db.collection('houses').doc(houseId).get();
            if (!doc.exists) return;
            const h = doc.data();
            document.getElementById('editHouseId').value = houseId;
            document.getElementById('editTitle').value = h.title;
            document.getElementById('editPrice').value = h.price;
            document.getElementById('editDescription').value = h.description || '';
            document.getElementById('editImage').value = (h.images && h.images[0]) ? h.images[0] : (h.image || '');
            document.getElementById('editHouseModal').style.display = 'flex';
        }
        function closeEditModal() { document.getElementById('editHouseModal').style.display = 'none'; }

        async function handleEditHouse(e) {
            e.preventDefault();
            const id = document.getElementById('editHouseId').value;
            await db.collection('houses').doc(id).update({
                title: document.getElementById('editTitle').value,
                price: Number(document.getElementById('editPrice').value),
                description: document.getElementById('editDescription').value,
                images: [document.getElementById('editImage').value]
            });
            closeEditModal();
            loadHouses();
            alert('Casa actualizada');
        }

        // --- SITEMAP GENERATOR ---
        async function generateSitemap() {
            const housesSnap = await db.collection('houses').get();
            const postsSnap = await db.collection('posts').get();
            const baseUrl = 'https://prehouses.es';

            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n';

            // Static pages
            xml += `  <url><loc>${baseUrl}/</loc><priority>1.0</priority></url>\n`;
            xml += `  <url><loc>${baseUrl}/catalogo.html</loc><priority>0.8</priority></url>\n`;
            xml += `  <url><loc>${baseUrl}/blog.html</loc><priority>0.8</priority></url>\n`;

            // Dynamic Houses
            housesSnap.forEach(doc => {
                xml += `  <url><loc>${baseUrl}/detalle-casa.html?id=${doc.id}</loc><priority>0.7</priority></url>\n`;
            });

            // Dynamic Posts
            postsSnap.forEach(doc => {
                // Assuming blog structure
                xml += `  <url><loc>${baseUrl}/articulo.html?id=${doc.id}</loc><priority>0.6</priority></url>\n`;
            });

            xml += '</urlset>';
            document.getElementById('sitemapOutput').value = xml;
        }

        async function initializeCatalog() {
            if (!confirm('Importar datos demo?')) return;
            // Sample implementation omitted for brevity, but function stub exists
            alert('Función de importación demo ejecutada (simulada).');
        }

        async function logout() {
            await auth.signOut();
            window.location.href = 'index.html';
        }
    </script>
</body>

</html>
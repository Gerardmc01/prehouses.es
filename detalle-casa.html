<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Casa Prefabricada | Prehouses</title>
    <meta name="description" id="pageDescription" content="Descubre esta casa prefabricada en Prehouses">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="favicon_prehouses_1764872622091.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <i class="fa-solid fa-house-chimney"></i> Prehouses
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="catalogo.html">Catálogo</a></li>
                <li><a href="blog.html">Blog</a></li>
                <li><a href="asesor.html" style="color: var(--primary); font-weight: 600;"><i
                            class="fa-solid fa-wand-magic-sparkles"></i> Asesor IA</a></li>
                <li><a href="usuarios.html">Acceso Empresas</a></li>
                <li><a href="usuarios.html" class="btn btn-primary" style="padding: 10px 24px; color: white;">Acceso
                        Usuarios</a></li>
            </ul>
        </div>
    </nav>

    <!-- Loading State -->
    <div id="loadingState" style="text-align: center; padding: 200px 20px;">
        <i class="fa-solid fa-spinner fa-spin" style="font-size: 4rem; color: var(--primary);"></i>
        <p style="margin-top: 20px; color: var(--text-light); font-size: 1.2rem;">Cargando casa...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" style="display: none; text-align: center; padding: 200px 20px;">
        <i class="fa-solid fa-house-circle-xmark" style="font-size: 5rem; color: #ef4444; margin-bottom: 30px;"></i>
        <h2>Casa no encontrada</h2>
        <p style="color: var(--text-light); margin: 20px 0;">La casa que buscas no existe o ha sido eliminada.</p>
        <a href="catalogo.html" class="btn btn-primary">Volver al Catálogo</a>
    </div>

    <!-- House Content (Hidden until loaded) -->
    <div id="houseContent" style="display: none;">
        <!-- Hero Section -->
        <section class="hero" id="heroSection"
            style="padding: 140px 0 60px; min-height: 500px; background-size: cover; background-position: center;">
            <div class="container hero-content">
                <h1 id="houseTitle">Cargando...</h1>
                <p id="houseSubtitle"></p>
            </div>
        </section>

        <!-- House Details -->
        <section class="featured" style="padding: 60px 0; background: white;">
            <div class="container">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 40px;">

                    <!-- Main Content -->
                    <div>
                        <!-- Specs -->
                        <div class="dashboard-card" style="margin-bottom: 30px;">
                            <h3><i class="fa-solid fa-info-circle"></i> Especificaciones</h3>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                                <div
                                    style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 12px;">
                                    <i class="fa-solid fa-ruler-combined"
                                        style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);"
                                        id="specArea">-</div>
                                    <div style="color: var(--text-light); font-size: 0.9rem;">Superficie</div>
                                </div>
                                <div
                                    style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 12px;">
                                    <i class="fa-solid fa-bed"
                                        style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);"
                                        id="specBedrooms">-</div>
                                    <div style="color: var(--text-light); font-size: 0.9rem;">Habitaciones</div>
                                </div>
                                <div
                                    style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 12px;">
                                    <i class="fa-solid fa-bath"
                                        style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);"
                                        id="specBathrooms">-</div>
                                    <div style="color: var(--text-light); font-size: 0.9rem;">Baños</div>
                                </div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="dashboard-card" style="margin-bottom: 30px;">
                            <h3><i class="fa-solid fa-align-left"></i> Descripción</h3>
                            <p id="houseDescription"
                                style="line-height: 1.8; color: var(--text-light); margin-top: 15px;">Cargando
                                descripción...</p>
                        </div>

                        <!-- Features -->
                        <div class="dashboard-card">
                            <h3><i class="fa-solid fa-star"></i> Características</h3>
                            <ul id="featuresList" style="list-style: none; padding: 0; margin-top: 15px;">
                                <li style="padding: 10px 0; border-bottom: 1px solid #e2e8f0;">
                                    <i class="fa-solid fa-check-circle" style="color: #10b981; margin-right: 10px;"></i>
                                    Cargando...
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div>
                        <!-- Price Card -->
                        <div class="dashboard-card"
                            style="margin-bottom: 30px; background: linear-gradient(135deg, var(--primary) 0%, #1e3a8a 100%); color: white;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 10px;">Precio</div>
                                <div style="font-size: 3rem; font-weight: 900; margin-bottom: 20px;" id="sidebarPrice">
                                    -€</div>
                                <button onclick="scrollToContact()" class="btn"
                                    style="width: 100%; background: white; color: var(--primary); font-weight: 700;">
                                    <i class="fa-solid fa-envelope"></i> Solicitar Información
                                </button>
                            </div>
                        </div>

                        <!-- Company Info -->
                        <div class="dashboard-card" id="companyCard">
                            <h4 style="margin-bottom: 15px;"><i class="fa-solid fa-building"></i> Empresa</h4>
                            <p id="companyName" style="font-weight: 700; color: var(--secondary); margin-bottom: 10px;">
                                Cargando...</p>
                            <p id="companyEmail" style="color: var(--text-light); font-size: 0.9rem;"><i
                                    class="fa-solid fa-envelope"></i> -</p>
                        </div>
                    </div>
                </div>

                <!-- Contact Form -->
                <div class="dashboard-card" id="contactSection" style="margin-top: 40px;">
                    <h3><i class="fa-solid fa-paper-plane"></i> Solicitar Información</h3>
                    <p style="color: var(--text-light); margin-bottom: 25px;">Rellena el formulario y la empresa se
                        pondrá en contacto contigo</p>

                    <form onsubmit="sendLead(event)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nombre</label>
                            <input type="text" id="leadName" required
                                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Email</label>
                            <input type="email" id="leadEmail" required
                                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Teléfono</label>
                            <input type="tel" id="leadPhone" required
                                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Mensaje</label>
                            <textarea id="leadMessage" rows="4" required
                                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;"></textarea>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px;">
                                <i class="fa-solid fa-paper-plane"></i> Enviar Solicitud
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h4>Prehouses</h4>
                    <p style="color: var(--text-light); margin-bottom: 20px;">El portal líder de casas prefabricadas en
                        España.</p>
                </div>
                <div class="footer-col">
                    <h4>Legal</h4>
                    <ul>
                        <li><a href="aviso-legal.html">Aviso Legal</a></li>
                        <li><a href="privacidad.html">Política de Privacidad</a></li>
                        <li><a href="cookies.html">Cookies</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2024 Prehouses. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Firebase Config -->
    <script src="js/firebase-config.js"></script>

    <script>
        let currentUser = null;
        let currentHouse = null;
        let houseId = null;

        // Get house ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        houseId = urlParams.get('id');

        // Auth state
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                // Pre-fill form if logged in
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById('leadName').value = userData.name || '';
                        document.getElementById('leadEmail').value = userData.email || '';
                        document.getElementById('leadPhone').value = userData.phone || '';
                    }
                });
            }
        });

        // Load house data
        async function loadHouse() {
            if (!houseId) {
                showError();
                return;
            }

            try {
                const doc = await db.collection('houses').doc(houseId).get();

                if (!doc.exists) {
                    showError();
                    return;
                }

                currentHouse = { id: doc.id, ...doc.data() };
                renderHouse(currentHouse);
                trackView();

            } catch (error) {
                console.error('Error loading house:', error);
                showError();
            }
        }

        function renderHouse(house) {
            // Update page title and meta
            document.getElementById('pageTitle').textContent = `${house.title} | Prehouses`;
            document.getElementById('pageDescription').content = house.description || `Descubre ${house.title} en Prehouses`;

            // Hero section
            const heroSection = document.getElementById('heroSection');
            heroSection.style.backgroundImage = `linear-gradient(rgba(15, 23, 42, 0.7), rgba(15, 23, 42, 0.8)), url('${house.imageUrl || 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&w=1200&q=80'}')`;

            document.getElementById('houseTitle').innerHTML = `<span>${house.title}</span>`;
            document.getElementById('houseSubtitle').textContent = house.category ? `Casa ${house.category.charAt(0).toUpperCase() + house.category.slice(1)}` : '';

            // Specs
            document.getElementById('specArea').textContent = `${house.area || 0}m²`;
            document.getElementById('specBedrooms').textContent = house.bedrooms || 0;
            document.getElementById('specBathrooms').textContent = house.bathrooms || 0;

            // Description
            document.getElementById('houseDescription').textContent = house.description || 'Sin descripción disponible.';

            // Features
            const featuresList = document.getElementById('featuresList');
            if (house.features && house.features.length > 0) {
                featuresList.innerHTML = house.features.map(feature => `
                    <li style="padding: 10px 0; border-bottom: 1px solid #e2e8f0;">
                        <i class="fa-solid fa-check-circle" style="color: #10b981; margin-right: 10px;"></i> ${feature}
                    </li>
                `).join('');
            } else {
                featuresList.innerHTML = '<li style="padding: 10px 0; color: var(--text-light);">No hay características especificadas.</li>';
            }

            // Price
            const price = parseInt(house.price || 0).toLocaleString('es-ES');
            document.getElementById('sidebarPrice').textContent = `${price}€`;

            // Company info
            document.getElementById('companyName').textContent = house.companyName || 'Empresa';
            document.getElementById('companyEmail').innerHTML = `<i class="fa-solid fa-envelope"></i> ${house.companyEmail || 'No disponible'}`;

            // Show content, hide loading
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('houseContent').style.display = 'block';
        }

        function showError() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
        }

        function scrollToContact() {
            document.getElementById('contactSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Send lead
        async function sendLead(event) {
            event.preventDefault();

            const name = document.getElementById('leadName').value.trim();
            const email = document.getElementById('leadEmail').value.trim();
            const phone = document.getElementById('leadPhone').value.trim();
            const message = document.getElementById('leadMessage').value.trim();

            if (!name || !email || !phone || !message) {
                alert('⚠️ Por favor, rellena todos los campos.');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('⚠️ Email no válido.');
                return;
            }

            try {
                await db.collection('leads').add({
                    userId: currentUser ? currentUser.uid : null,
                    userName: name,
                    userEmail: email,
                    userPhone: phone,
                    message: message,
                    houseId: currentHouse.id,
                    houseTitle: currentHouse.title,
                    companyId: currentHouse.companyId || 'unknown',
                    status: 'nuevo',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('✅ ¡Solicitud enviada! La empresa se pondrá en contacto contigo pronto.');

                // Clear form
                document.getElementById('leadName').value = '';
                document.getElementById('leadEmail').value = '';
                document.getElementById('leadPhone').value = '';
                document.getElementById('leadMessage').value = '';

            } catch (error) {
                console.error('Error sending lead:', error);
                alert('❌ Error al enviar la solicitud. Inténtalo de nuevo.');
            }
        }

        // Track view
        async function trackView() {
            try {
                await db.collection('views').add({
                    houseId: currentHouse.id,
                    houseTitle: currentHouse.title,
                    companyId: currentHouse.companyId || 'unknown',
                    userId: currentUser ? currentUser.uid : null,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userAgent: navigator.userAgent,
                    referrer: document.referrer || 'direct'
                });
            } catch (error) {
                console.error('Error tracking view:', error);
            }
        }

        // Load house on page load
        loadHouse();
    </script>

</body>

</html>
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Casa | Prehouses</title>
    <link rel="stylesheet" href="styles.css?v=3">
    <!-- ... -->
    <script src="js/comparator-logic.js?v=2"></script>
    <link rel="icon" type="image/png" href="favicon_prehouses_1764872622091.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css?v=3">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        .detail-container {
            margin-top: 140px;
            margin-bottom: 60px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
        }

        .detail-gallery {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .main-image {
            width: 100%;
            height: 400px;
            background: #f1f5f9;
        }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-info h1 {
            font-size: 2.5rem;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .detail-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 30px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-light);
        }

        .contact-form-card {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 120px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
        }

        @media (max-width: 900px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }

            .mobile-actions {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background: white;
                padding: 15px;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
                z-index: 9999;
                gap: 15px;
                align-items: center;
            }

            .mobile-actions button {
                width: 50px;
                height: 50px;
                border-radius: 12px;
                border: 2px solid #e2e8f0;
                background: white;
                font-size: 1.2rem;
                color: var(--secondary);
                cursor: pointer;
            }

            .mobile-actions button.active {
                color: red;
                border-color: red;
                background: #fff0f0;
            }

            .mobile-actions .btn-primary {
                background: var(--primary) !important;
                color: white !important;
                border: none !important;
                flex: 1;
                font-weight: 600;
                width: auto;
            }

            .detail-container {
                margin-bottom: 100px;
            }
        }

        /* Drawer Styles */
        .comparison-drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9999;
            display: none;
        }

        .comparison-drawer {
            position: fixed;
            top: 0;
            right: -450px;
            width: 400px;
            max-width: 90vw;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .comparison-drawer.open {
            right: 0;
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .drawer-house-card {
            display: flex;
            gap: 15px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .drawer-house-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .drawer-house-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            background: #f1f5f9;
        }

        /* Modal VS Styles */
        .vs-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10001;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .vs-content {
            background: white;
            width: 100%;
            max-width: 900px;
            border-radius: 24px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .vs-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vs-body {
            overflow-y: auto;
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        @media (max-width: 768px) {
            .vs-body {
                gap: 20px;
                padding: 15px;
            }
        }

        .vs-column {
            text-align: center;
        }

        .vs-img-wrapper {
            position: relative;
            margin-bottom: 20px;
            border-radius: 16px;
            overflow: hidden;
            aspect-ratio: 16/9;
        }

        .vs-img-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .vs-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }

        .vs-stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.95rem;
        }

        .vs-stat-label {
            color: var(--text-light);
            font-weight: 500;
        }

        .vs-stat-value {
            font-weight: 600;
            color: var(--secondary);
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <i class="fa-solid fa-house-chimney"></i> Prehouses
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="catalogo.html">Catálogo</a></li>
                <li><a href="blog.html">Blog</a></li>
                <li><a href="asesor.html" style="color: var(--primary); font-weight: 600;"><i
                            class="fa-solid fa-wand-magic-sparkles"></i> Asesor IA</a></li>
                <li><a href="acceso.html" class="btn btn-primary" style="padding: 10px 24px; color: white;">Acceso</a>
                </li>
            </ul>
            <div class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="catalogo.html">Catálogo</a></li>
            <li><a href="blog.html">Blog</a></li>
            <li><a href="asesor.html" style="color: var(--primary); font-weight: 600;"><i
                        class="fa-solid fa-wand-magic-sparkles"></i> Asesor IA</a></li>
            <li><a href="acceso.html" class="btn btn-primary" style="width: 100%; margin-top: 20px;">Acceso</a></li>
        </ul>
    </div>

    <script>
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const toggle = document.querySelector('.mobile-menu-toggle');
            menu.classList.toggle('active');
            toggle.classList.toggle('active');
        }
    </script>
    <!-- Main Detail Content -->
    <div class="container detail-container" style="margin-top: 100px; padding-bottom: 60px;">
        <div class="detail-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 40px;">
            <!-- Main Content -->
            <div class="detail-content">
                <div class="gallery-section">
                    <img id="houseImage" src="" alt="Casa principal"
                        style="width: 100%; border-radius: 12px; height: 400px; object-fit: cover; margin-bottom: 20px; background-color: #f1f5f9;">
                </div>

                <div class="house-info-section">
                    <div
                        style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <div>
                            <span id="houseCategoryBadge" class="house-badge"
                                style="background: var(--primary); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; display: inline-block;">Categoría</span>
                            <h1 id="houseTitle" style="font-size: 2.2rem; color: var(--secondary); margin: 5px 0;">
                                Cargando...</h1>
                            <p style="color: var(--text-light);"><i class="fa-solid fa-map-marker-alt"></i> <span
                                    id="houseProvince">España</span></p>
                        </div>
                        <div class="price-tag" style="text-align: right;">
                            <div id="housePrice" style="font-size: 2rem; font-weight: 700; color: var(--primary);">0€
                            </div>
                            <span style="font-size: 0.9rem; color: var(--text-light);">IVA no incluido</span>
                        </div>
                    </div>

                    <!-- Specs Grid -->
                    <div
                        style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; background: #f8fafc; padding: 20px; border-radius: 12px;">
                        <div style="text-align: center;">
                            <i class="fa-solid fa-ruler-combined"
                                style="font-size: 1.5rem; color: var(--primary); margin-bottom: 8px;"></i>
                            <div style="font-weight: 600;">Superficie</div>
                            <div><span id="houseArea">0</span> m²</div>
                        </div>
                        <div style="text-align: center;">
                            <i class="fa-solid fa-bed"
                                style="font-size: 1.5rem; color: var(--primary); margin-bottom: 8px;"></i>
                            <div style="font-weight: 600;">Habitaciones</div>
                            <span id="houseBedrooms">0</span>
                        </div>
                        <div style="text-align: center;">
                            <i class="fa-solid fa-bath"
                                style="font-size: 1.5rem; color: var(--primary); margin-bottom: 8px;"></i>
                            <div style="font-weight: 600;">Baños</div>
                            <span id="houseBathrooms">0</span>
                        </div>
                        <div style="text-align: center;">
                            <i class="fa-solid fa-truck-fast"
                                style="font-size: 1.5rem; color: var(--primary); margin-bottom: 8px;"></i>
                            <div style="font-weight: 600;">Entrega</div>
                            <span id="houseDelivery">Consultar</span>
                        </div>
                    </div>

                    <div class="description-section" style="margin-bottom: 30px;">
                        <h3 style="color: var(--secondary); margin-bottom: 15px;">Descripción</h3>
                        <p id="houseDescription"
                            style="line-height: 1.8; color: var(--text-light); white-space: pre-line;">Cargando
                            descripción...</p>
                    </div>

                    <!-- Features List -->
                    <div id="featuresSection" style="margin-bottom: 40px; display: none;">
                        <h3 style="color: var(--secondary); margin-bottom: 15px;">Características Destacadas</h3>
                        <div id="featuresList"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                            <!-- Features will be injected here -->
                        </div>
                    </div>

                    <!-- Similar Houses Section (Placeholder) -->
                    <div id="similarHousesSection" style="margin-top: 50px;">
                        <h3 style="margin-bottom: 20px;">También te puede interesar</h3>
                        <div id="similarHousesGrid" class="house-grid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sticky-sidebar" style="position: sticky; top: 100px;">
                    <!-- Contact Card Dynamic Container -->
                    <div id="contactCardContainer"
                        style="background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                        <h3 style="margin-bottom: 20px; color: var(--secondary);">Contactar</h3>
                        <!-- Form will be injected here or Buttons -->
                        <div class="loading-spinner" style="text-align: center; padding: 20px;">
                            <i class="fa-solid fa-spinner fa-spin"></i>
                        </div>
                    </div>

                    <!-- Comparison Button -->
                    <div style="margin-top: 20px;">
                        <button onclick="addToComparisonWithCurrent()" class="btn btn-outline"
                            style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px;">
                            <i class="fa-solid fa-code-compare"></i> Comparar Propiedad
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Action Bar -->
    <div class="mobile-actions" style="display: none;">
        <button onclick="toggleFav(event, houseId)"><i class="fa-regular fa-heart"></i></button>
        <button class="btn-primary"
            onclick="document.querySelector('.sidebar').scrollIntoView({behavior: 'smooth'})">Contactar</button>
    </div>

    <script src="js/support.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/comparator-logic.js"></script>

    <script>
        // --- INSTANT COMPARATOR LOGIC ---
        // Replaces old localStorage logic on this page for instant gratification
        function addToComparisonWithCurrent() {
            openComparisonDrawer();
        }

        let comparisonCandidates = [];

        async function openComparisonDrawer() {
            document.getElementById('comparisonDrawer').classList.add('open');
            document.getElementById('drawerOverlay').style.display = 'block';

            if (comparisonCandidates.length > 0) {
                renderDrawerList();
                return;
            }

            try {
                // Load candidates (same category if possible)
                let q = db.collection('houses');
                if (currentHouse && currentHouse.category) {
                    q = q.where('category', '==', currentHouse.category).limit(10);
                } else {
                    q = q.limit(10);
                }

                const snap = await q.get();
                comparisonCandidates = [];
                snap.forEach(doc => {
                    if (doc.id !== houseId) { // Exclude itself
                        comparisonCandidates.push({ id: doc.id, ...doc.data() });
                    }
                });
                renderDrawerList();

            } catch (e) {
                console.error(e);
                document.getElementById('drawerList').innerHTML = '<p>Error cargando lista</p>';
            }
        }

        function closeComparisonDrawer() {
            document.getElementById('comparisonDrawer').classList.remove('open');
            document.getElementById('drawerOverlay').style.display = 'none';
        }

        function renderDrawerList() {
            const list = document.getElementById('drawerList');
            if (comparisonCandidates.length === 0) {
                list.innerHTML = '<p style="text-align:center; padding:20px;">No hay casas similares para comparar en esta categoría.</p>';
                return;
            }

            let html = '';
            comparisonCandidates.forEach(h => {
                const img = Array.isArray(h.images) ? h.images[0] : (h.image || 'https://via.placeholder.com/100');
                const price = typeof h.price === 'number' ? h.price.toLocaleString() + '€' : h.price;

                html += `
                    <div class="drawer-house-card" onclick="openVsModal('${h.id}')">
                        <img src="${img}" class="drawer-house-img" alt="${h.title}" onerror="this.src='https://via.placeholder.com/100'">
                        <div style="flex:1;">
                            <h4 style="margin:0 0 5px 0; font-size:0.95rem; line-height:1.2;">${h.title}</h4>
                            <p style="margin:0; font-weight:700; color:var(--primary); font-size:1.1rem;">${price}</p>
                            <span style="font-size:0.8rem; color:#64748b; margin-top:5px; display:inline-block;"><i class="fa-solid fa-arrow-right-arrow-left"></i> Comparar</span>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        function openVsModal(otherId) {
            const other = comparisonCandidates.find(c => c.id === otherId);
            if (!other) return;

            closeComparisonDrawer();

            const currentImg = Array.isArray(currentHouse.images) ? currentHouse.images[0] : (currentHouse.image || '');
            const otherImg = Array.isArray(other.images) ? other.images[0] : (other.image || '');

            const renderVal = (v, suffix = '') => ((v !== undefined && v !== null && v !== '') ? v + suffix : '-');
            const formatPrice = (p) => typeof p === 'number' ? p.toLocaleString() : p;

            const html = `
                <div class="vs-column">
                    <div class="vs-img-wrapper"><img src="${currentImg}" onerror="this.src='https://via.placeholder.com/400'"></div>
                    <h3 style="color:var(--secondary); font-size:1.2rem; margin-bottom:5px;">${currentHouse.title}</h3>
                    <div class="vs-price">${formatPrice(currentHouse.price)}€</div>
                    <div style="background:#f0fdf4; color:#166534; padding:5px 10px; border-radius:20px; display:inline-block; font-size:0.8rem; font-weight:600; margin-bottom:15px;">Casa Actual</div>
                    
                    <div class="vs-stat-row"><span class="vs-stat-label">Superficie</span> <span class="vs-stat-value">${renderVal(currentHouse.area, ' m²')}</span></div>
                    <div class="vs-stat-row"><span class="vs-stat-label">Habitaciones</span> <span class="vs-stat-value">${renderVal(currentHouse.bedrooms)}</span></div>
                    <div class="vs-stat-row"><span class="vs-stat-label">Baños</span> <span class="vs-stat-value">${renderVal(currentHouse.bathrooms)}</span></div>
                    <div class="vs-stat-row"><span class="vs-stat-label">Entrega</span> <span class="vs-stat-value">${renderVal(currentHouse.deliveryTime)}</span></div>
                </div>
                
                <div class="vs-column" style="border-left: 1px solid #f1f5f9;">
                    <div class="vs-img-wrapper"><img src="${otherImg}" onerror="this.src='https://via.placeholder.com/400'"></div>
                    <h3 style="color:var(--secondary); font-size:1.2rem; margin-bottom:5px;">${other.title}</h3>
                    <div class="vs-price">${formatPrice(other.price)}€</div>
                    <div style="background:#e0f2fe; color:#0369a1; padding:5px 10px; border-radius:20px; display:inline-block; font-size:0.8rem; font-weight:600; margin-bottom:15px;">Comparada</div>
                    
                    <div class="vs-stat-row"><span class="vs-stat-label">Superficie</span> <span class="vs-stat-value">${renderVal(other.area, ' m²')}</span></div>
                    <div class="vs-stat-row"><span class="vs-stat-label">Habitaciones</span> <span class="vs-stat-value">${renderVal(other.bedrooms)}</span></div>
                    <div class="vs-stat-row"><span class="vs-stat-label">Baños</span> <span class="vs-stat-value">${renderVal(other.bathrooms)}</span></div>
                    <div class="vs-stat-row"><span class="vs-stat-label">Entrega</span> <span class="vs-stat-value">${renderVal(other.deliveryTime)}</span></div>
                    
                    <a href="detalle-casa.html?id=${other.id}" class="btn btn-outline" style="width:100%; margin-top:20px;">Ver Ficha</a>
                </div>
            `;

            document.getElementById('vsBody').innerHTML = html;
            document.getElementById('vsModal').style.display = 'flex';
        }

        function closeVsModal() {
            document.getElementById('vsModal').style.display = 'none';
        }
        const urlParams = new URLSearchParams(window.location.search);
        const houseId = urlParams.get('id');
        let currentHouse = null;
        let currentUser = null;

        // Auth Listener
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                document.getElementById('leadEmail').value = user.email;
                checkFavorite();
            }
        });

        // Datos de Fallback para casas no encontradas o demos
        const demoHouse = {
            title: "Casa Modelo Premium (Demo)",
            price: 85000,
            area: 120,
            bedrooms: 3,
            bathrooms: 2,
            deliveryTime: "3-4 meses",
            description: "Esta es una ficha de ejemplo para demostrar el diseño. Una casa modular moderna con acabados de primera calidad, eficiencia energética A+ y diseño bioclimático adaptable a cualquier terreno.",
            images: ["https://images.unsplash.com/photo-1582268611958-ebfd161ef9cf?auto=format&fit=crop&w=1200&q=80"],
            companyId: "demo_company",
            category: "madera"
        };

        async function loadHouse() {
            if (!houseId) {
                // Si no hay ID, mostrar demo
                currentHouse = demoHouse;
                renderHouse(currentHouse);
                return;
            }

            try {
                const doc = await db.collection('houses').doc(houseId).get();
                if (!doc.exists) {
                    // En lugar de error, mostramos la Demo House para que no se vea feo
                    console.log('Casa no encontrada, mostrando demo');
                    currentHouse = { ...demoHouse, title: "Modelo No Disponible (Visualización)" };
                    renderHouse(currentHouse);
                    return;
                }

                currentHouse = doc.data();
                // Validar que tenga imagen, si no, usar fallback
                if (!currentHouse.images && !currentHouse.image) {
                    currentHouse.images = demoHouse.images;
                }
                renderHouse(currentHouse);

            } catch (error) {
                console.error('Error loading house:', error);
                // Fallback en caso de error de red
                currentHouse = demoHouse;
                renderHouse(currentHouse);
            }
        }

        function renderHouse(house) {
            document.title = `${house.title} | Prehouses`;

            // Helper functions for safe setting
            const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            const setSrc = (id, val) => { const el = document.getElementById(id); if (el) el.src = val; };

            setText('houseTitle', house.title);
            setText('housePrice', `${parseInt(house.price).toLocaleString()}€`);
            setText('houseArea', house.area);
            setText('houseBedrooms', house.bedrooms || 2);
            setText('houseBathrooms', house.bathrooms || 1);
            setText('houseDelivery', house.deliveryTime || 'Consultar');
            setText('houseDescription', house.description);
            setText('houseCategoryBadge', (house.category || 'Casa').toUpperCase());
            setText('houseProvince', house.province || 'España');

            // Features Logic
            const featuresSection = document.getElementById('featuresSection');
            const featuresList = document.getElementById('featuresList');
            if (house.features && house.features.length > 0) {
                featuresSection.style.display = 'block';
                featuresList.innerHTML = house.features.map(f => `
                    <div style="display: flex; align-items: center; gap: 10px; color: var(--text-main); font-size: 0.95rem;">
                        <i class="fa-solid fa-check" style="color: #10b981;"></i> ${f}
                    </div>
                `).join('');
            } else {
                featuresSection.style.display = 'none';
            }

            // Image handling
            let imageUrl = '';
            if (Array.isArray(house.images) && house.images.length > 0) {
                imageUrl = house.images[0];
            } else if (typeof house.images === 'string') {
                imageUrl = house.images;
            } else if (house.image) {
                imageUrl = house.image;
            } else {
                imageUrl = 'https://via.placeholder.com/800x600?text=No+Image';
            }
            setSrc('houseImage', imageUrl);

            // --- CONTACT CARD LOGIC ---
            const contactContainer = document.getElementById('contactCardContainer');
            if (contactContainer) {
                // Check if it's a Manual (External) house OR a Platform house
                // We use isManual flag OR externalUrl existence
                if (house.isManual === true || house.externalUrl) {
                    // Manual/External Mode
                    contactContainer.innerHTML = `
                        <div class="company-branding" style="text-align: center; margin-bottom: 20px;">
                            ${house.companyLogo ? `<img src="${house.companyLogo}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid #f1f5f9;">` : '<i class="fa-solid fa-building" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 10px;"></i>'}
                            <h4 style="margin: 0; color: var(--secondary); font-size: 1.1rem;">${house.companyName || 'Empresa Colaboradora'}</h4>
                            <p style="font-size: 0.85rem; color: #16a34a; margin-top: 5px;"><i class="fa-solid fa-circle-check"></i> Vendedor Verificado</p>
                        </div>
                        
                        <div class="action-buttons" style="display: flex; flex-direction: column; gap: 12px;">
                            ${house.externalUrl ? `
                            <a href="${house.externalUrl}" target="_blank" class="btn btn-primary" style="width: 100%; text-align: center; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fa-solid fa-globe"></i> Visitar Web Oficial
                            </a>` : ''}
                            
                            ${house.contactPhone ? `
                            <a href="tel:${house.contactPhone}" class="btn btn-outline" style="width: 100%; text-align: center; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fa-solid fa-phone"></i> Llamar: ${house.contactPhone}
                            </a>
                            <a href="https://wa.me/${house.contactPhone.replace(/\s+/g, '')}" target="_blank" class="btn" style="width: 100%; text-align: center; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; background: #25D366; color: white;">
                                <i class="fa-brands fa-whatsapp"></i> WhatsApp
                            </a>` : ''}

                            ${house.contactEmail ? `
                            <a href="mailto:${house.contactEmail}" class="btn btn-outline" style="width: 100%; text-align: center; padding: 12px; border-color: #e2e8f0; color: var(--text-main); display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fa-regular fa-envelope"></i> Enviar Email
                            </a>` : ''}
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #f1f5f9;">
                            <p style="font-size: 0.8rem; color: var(--text-light); text-align: center; margin-bottom: 10px;">
                                Ubicación de la empresa:
                            </p>
                            <p style="font-size: 0.85rem; color: var(--secondary); text-align: center; line-height: 1.4;">
                                <i class="fa-solid fa-location-dot" style="color: var(--primary);"></i> ${house.companyAddress || 'España'}
                            </p>
                        </div>
                    `;
                } else {
                    // Standard Mode (Lead Form) - For Company Dashboard Houses
                    contactContainer.innerHTML = `
                        <div class="company-header" style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                ${house.companyName ? house.companyName.charAt(0).toUpperCase() : 'P'}
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 0.95rem;">${house.companyName || 'Prehouses'}</div>
                                <div style="font-size: 0.8rem; color: var(--text-light);">Suele responder en 24h</div>
                            </div>
                        </div>
                    
                        <form id="leadForm" onsubmit="handleLeadSubmit(event)">
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500;">Nombre</label>
                                <input type="text" id="leadName" required style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500;">Email</label>
                                <input type="email" id="leadEmail" required style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500;">Teléfono</label>
                                <input type="tel" id="leadPhone" required style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500;">Mensaje</label>
                                <textarea id="leadMessage" rows="3" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">Hola, me interesa el ${house.title} y me gustaría recibir más información.</textarea>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">Contactar Ahora</button>
                            <p style="font-size: 0.75rem; color: var(--text-light); margin-top: 10px; text-align: center; line-height: 1.4;">
                                Al enviar aceptas nuestra <a href="privacidad.html" style="color: inherit; text-decoration: underline;">Política de Privacidad</a>.
                            </p>
                        </form>
                    `;

                    // Pre-fill if user is logged in (re-apply logic)
                    if (currentUser) {
                        const emailInput = document.getElementById('leadEmail');
                        if (emailInput) emailInput.value = currentUser.email;
                    }
                }
            }

            updateMetaTags(house, imageUrl);
            loadSimilarHouses(house.category);
        }

        function updateMetaTags(house, imageUrl) {
            // Title
            document.title = `${house.title} | Prehouses`;

            // Meta Description
            const desc = `Compra ${house.title} por ${parseInt(house.price).toLocaleString()}€. ${house.description.substring(0, 150)}...`;
            setMetaTag('name', 'description', desc);

            // Open Graph (Facebook, LinkedIn, WhatsApp)
            setMetaTag('property', 'og:title', `${house.title} | Prehouses`);
            setMetaTag('property', 'og:description', desc);
            setMetaTag('property', 'og:image', imageUrl);
            setMetaTag('property', 'og:url', window.location.href);
            setMetaTag('property', 'og:type', 'product');

            // Twitter Card
            setMetaTag('name', 'twitter:card', 'summary_large_image');
            setMetaTag('name', 'twitter:title', `${house.title} | Prehouses`);
            setMetaTag('name', 'twitter:description', desc);
            setMetaTag('name', 'twitter:image', imageUrl);
        }

        function setMetaTag(attrName, attrValue, content) {
            let element = document.querySelector(`meta[${attrName}="${attrValue}"]`);
            if (!element) {
                element = document.createElement('meta');
                element.setAttribute(attrName, attrValue);
                document.head.appendChild(element);
            }
            element.setAttribute('content', content);
        }

        async function loadSimilarHouses(category) {
            if (!category) {
                document.getElementById('similarHousesSection').style.display = 'none';
                return;
            }

            const container = document.getElementById('similarHousesGrid');
            try {
                const snapshot = await db.collection('houses')
                    .where('category', '==', category)
                    .limit(4)
                    .get();

                let html = '';
                let count = 0;

                snapshot.forEach(doc => {
                    if (doc.id === houseId || count >= 3) return;

                    const house = doc.data();
                    const img = Array.isArray(house.images) ? house.images[0] : (house.image || 'https://via.placeholder.com/400');

                    html += `
                        <a href="detalle-casa.html?id=${doc.id}" class="house-card">
                            <div class="house-image">
                                <img src="${img}" alt="${house.title}" onerror="this.src='https://via.placeholder.com/400'">
                            </div>
                            <div class="house-content">
                                <div class="house-header">
                                    <div class="house-price">${parseInt(house.price).toLocaleString()}€</div>
                                </div>
                                <h3 class="house-title">${house.title}</h3>
                                <div class="house-footer">
                                    <span class="btn btn-outline" style="width: 100%; text-align: center;">Ver Casa</span>
                                </div>
                            </div>
                        </a>
                    `;
                    count++;
                });

                if (html) {
                    container.innerHTML = html;
                } else {
                    document.getElementById('similarHousesSection').style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading similar houses:', error);
                document.getElementById('similarHousesSection').style.display = 'none';
            }
        }

        // Send Lead
        async function sendLead(e) {
            e.preventDefault();
            const btn = document.getElementById('leadBtn');
            btn.disabled = true;
            btn.innerText = 'Enviando...';

            try {
                await db.collection('leads').add({
                    houseId: houseId,
                    houseTitle: currentHouse.title,
                    companyId: currentHouse.companyId,
                    userName: document.getElementById('leadName').value,
                    userEmail: document.getElementById('leadEmail').value,
                    userPhone: document.getElementById('leadPhone').value,
                    message: document.getElementById('leadMessage').value,
                    status: 'nuevo',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('✅ Solicitud enviada correctamente. La empresa te contactará pronto.');
                e.target.reset();
            } catch (error) {
                console.error('Error sending lead:', error);
                alert('Error al enviar solicitud');
            } finally {
                btn.disabled = false;
                btn.innerText = 'Enviar Solicitud';
            }
        }

        // Favorites Logic
        function updateFavUI(isSaved) {
            const targets = [
                { id: 'favBtn', textSaved: ' Guardado', textUnsaved: ' Guardar Favorito' },
                { id: 'mobileFavBtn', textSaved: '', textUnsaved: '' },
                { id: 'mainFavBtn', textSaved: '<span>Guardado</span>', textUnsaved: '<span>Favorito</span>' }
            ];

            targets.forEach(t => {
                const btn = document.getElementById(t.id);
                if (!btn) return;

                const icon = isSaved ? '<i class="fa-solid fa-heart" style="color: red;"></i>' : '<i class="fa-regular fa-heart"></i>';

                if (t.id === 'mainFavBtn') {
                    btn.innerHTML = `${icon} ${isSaved ? t.textSaved : t.textUnsaved}`;
                } else {
                    btn.innerHTML = `${icon}${isSaved ? t.textSaved : t.textUnsaved}`;
                }

                if (isSaved) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        }

        async function checkFavorite() {
            if (!currentUser || !houseId) return;
            const snap = await db.collection('favorites')
                .where('userId', '==', currentUser.uid)
                .where('houseId', '==', houseId)
                .get();

            if (!snap.empty) {
                updateFavUI(true);
            }
        }

        async function toggleFavorite() {
            if (!currentUser) return alert('Debes iniciar sesión para guardar favoritos.');

            const btn = document.getElementById('favBtn');
            const isSaved = btn.innerHTML.includes('fa-solid');

            // Optimistic UI update
            updateFavUI(!isSaved);

            try {
                if (isSaved) {
                    // Remove
                    const snap = await db.collection('favorites')
                        .where('userId', '==', currentUser.uid)
                        .where('houseId', '==', houseId)
                        .get();
                    snap.forEach(doc => doc.ref.delete());
                    // console.log('Removed'); 
                } else {
                    // Add
                    await db.collection('favorites').add({
                        userId: currentUser.uid,
                        houseId: houseId,
                        houseTitle: currentHouse.title,
                        housePrice: currentHouse.price,
                        houseImage: document.getElementById('houseImage').src,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    // console.log('Added');
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
                // Revert UI on error
                updateFavUI(isSaved);
                alert('Error al guardar favorito');
            }
        }

        // Init
        loadHouse();
    </script>

</body>

</html>
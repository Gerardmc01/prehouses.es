<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Casa | Prehouses</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="favicon_prehouses_1764872622091.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        .detail-container {
            margin-top: 140px;
            margin-bottom: 60px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
        }

        .detail-gallery {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .main-image {
            width: 100%;
            height: 400px;
            background: #f1f5f9;
        }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-info h1 {
            font-size: 2.5rem;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .detail-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 30px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-light);
        }

        .contact-form-card {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 120px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
        }

        @media (max-width: 900px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }

            .mobile-actions {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background: white;
                padding: 15px;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
                z-index: 9999;
                gap: 15px;
                align-items: center;
            }

            .mobile-actions button {
                width: 50px;
                height: 50px;
                border-radius: 12px;
                border: 2px solid #e2e8f0;
                background: white;
                font-size: 1.2rem;
                color: var(--secondary);
                cursor: pointer;
            }

            .mobile-actions button.active {
                color: red;
                border-color: red;
                background: #fff0f0;
            }

            .mobile-actions .btn-primary {
                background: var(--primary) !important;
                color: white !important;
                border: none !important;
                flex: 1;
                font-weight: 600;
                width: auto;
            }

            .detail-container {
                margin-bottom: 100px;
            }
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <img src="favicon_prehouses_1764872622091.png" alt="Logo"
                    style="width: 30px; height: 30px; margin-right: 10px; border-radius: 4px;">
                Prehouses
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="catalogo.html">Catálogo</a></li>
                <li><a href="blog.html">Blog</a></li>
                <li><a href="empresas.html">Acceso Empresas</a></li>
                <li><a href="usuarios.html" class="btn btn-primary" style="padding: 10px 24px;">Acceso Usuarios</a></li>
            </ul>
        </div>
    </nav>

    <!-- Product Detail -->
    <div class="container detail-container">
        <div class="detail-grid">

            <!-- Left Column: Gallery & Info -->
            <div class="detail-content">
                <div class="detail-gallery">
                    <div class="main-image">
                        <img id="houseImage" src="" alt="Imagen Casa">
                    </div>
                </div>

                <div class="detail-info" style="margin-top: 40px;">
                    <div class="detail-tags" id="houseTags">
                        <!-- Tags injected via JS -->
                    </div>
                    <h1 id="houseTitle">Cargando...</h1>
                    <div class="detail-price" id="housePrice">...</div>

                    <div class="features-box">
                        <h3 style="margin-bottom: 20px; color: var(--secondary);">Características Principales</h3>
                        <div class="features-grid">
                            <div class="feature-item"><i class="fa-solid fa-ruler-combined"></i> <span
                                    id="houseArea">-</span> m²</div>
                            <div class="feature-item"><i class="fa-solid fa-bed"></i> <span id="houseBedrooms">-</span>
                                Hab.</div>
                            <div class="feature-item"><i class="fa-solid fa-bath"></i> <span
                                    id="houseBathrooms">-</span> Baños</div>
                            <div class="feature-item"><i class="fa-solid fa-clock"></i> <span
                                    id="houseDelivery">-</span></div>
                        </div>
                    </div>

                    <div class="detail-description">
                        <h3 style="margin-bottom: 15px; color: var(--secondary);">Descripción del Modelo</h3>
                        <p id="houseDescription" style="line-height: 1.6; color: var(--text-light);">
                            <!-- Description injected via JS -->
                        </p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Contact Form -->
            <div class="detail-sidebar">
                <div class="contact-form-card">
                    <h3>Contactar Fabricante</h3>
                    <p style="margin-bottom: 20px; font-size: 0.9rem; color: var(--text-light);">
                        Solicita más información directamente a <strong id="companyName">la empresa</strong>.
                    </p>
                    <form onsubmit="sendLead(event)">
                        <div class="form-group">
                            <label>Nombre Completo</label>
                            <input type="text" id="leadName" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="leadEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono</label>
                            <input type="tel" id="leadPhone" required>
                        </div>
                        <div class="form-group">
                            <label>Mensaje</label>
                            <textarea id="leadMessage" rows="4"
                                required>Hola, estoy interesado en este modelo...</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;" id="leadBtn">Enviar
                            Solicitud</button>

                        <button type="button" onclick="toggleFavorite()" class="btn btn-outline"
                            style="width: 100%; margin-top: 10px;" id="favBtn">
                            <i class="fa-regular fa-heart"></i> Guardar Favorito
                        </button>

                        <button type="button" onclick="addToComparisonWithCurrent()" class="btn btn-outline"
                            style="width: 100%; margin-top: 10px;">
                            <i class="fa-solid fa-scale-balanced"></i> Comparar
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
    </div>

    <!-- Similar Houses -->
    <div class="container" id="similarHousesSection" style="margin-bottom: 60px;">
        <h2 style="margin-bottom: 30px; color: var(--secondary);">También te podría interesar</h2>
        <div class="house-grid" id="similarHousesGrid"
            style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
            <div style="text-align:center; width:100%; padding:20px;">Cargando recomendaciones...</div>
        </div>
    </div>

    <!-- Mobile Action Bar -->
    <div class="mobile-actions" style="display: none;">
        <button onclick="toggleFavorite()" id="mobileFavBtn"><i class="fa-regular fa-heart"></i></button>
        <button onclick="addToComparisonWithCurrent()"><i class="fa-solid fa-scale-balanced"></i></button>
        <button onclick="document.querySelector('.contact-form-card').scrollIntoView({behavior:'smooth'})"
            class="btn-primary">Contactar</button>
    </div>

    <!-- Firebase Config -->
    <script src="js/firebase-config.js"></script>
    <script src="js/support.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/comparator-logic.js"></script>

    <script>
        // Wrapper because currentHouse is a global var here
        function addToComparisonWithCurrent() {
            if (!currentHouse) {
                if (typeof showToast === 'function') showToast('Cargando datos...', 'info');
                return;
            }
            // Add id because it's detached
            currentHouse.id = houseId;
            addToComparison(currentHouse);
        }
        const urlParams = new URLSearchParams(window.location.search);
        const houseId = urlParams.get('id');
        let currentHouse = null;
        let currentUser = null;

        // Auth Listener
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                document.getElementById('leadEmail').value = user.email;
                checkFavorite();
            }
        });

        // Load House Data
        async function loadHouse() {
            if (!houseId) {
                alert('No se especificó ninguna casa.');
                window.location.href = 'catalogo.html';
                return;
            }

            try {
                const doc = await db.collection('houses').doc(houseId).get();
                if (!doc.exists) {
                    document.querySelector('.detail-container').innerHTML = '<h2>Casa no encontrada</h2><a href="catalogo.html">Volver al catálogo</a>';
                    return;
                }

                currentHouse = doc.data();
                renderHouse(currentHouse);
            } catch (error) {
                console.error('Error loading house:', error);
            }
        }

        function renderHouse(house) {
            document.title = `${house.title} | Prehouses`;
            document.getElementById('houseTitle').textContent = house.title;
            document.getElementById('housePrice').textContent = `${house.price.toLocaleString()}€`;
            document.getElementById('houseArea').textContent = house.area;
            document.getElementById('houseBedrooms').textContent = house.bedrooms;
            document.getElementById('houseBathrooms').textContent = house.bathrooms;
            document.getElementById('houseDelivery').textContent = house.deliveryTime || 'Consultar';
            document.getElementById('houseDescription').textContent = house.description;
            const companyLink = house.companyId ? `<a href="empresa-perfil.html?id=${house.companyId}" style="color: var(--primary); text-decoration: none; font-weight: bold;">${house.companyName || 'la empresa'}</a>` : 'la empresa';
            document.getElementById('companyName').innerHTML = companyLink;

            // Image handling (array or string)
            let imageUrl = '';
            if (Array.isArray(house.images) && house.images.length > 0) {
                imageUrl = house.images[0];
            } else if (typeof house.images === 'string') {
                imageUrl = house.images;
            } else if (house.image) {
                imageUrl = house.image;
            }

            if (imageUrl) {
                document.getElementById('houseImage').src = imageUrl;
            }

            // --- SEO & SOCIAL SHARING ---
            updateMetaTags(house, imageUrl);

            // Load Similar Houses
            loadSimilarHouses(house.category);
        }

        function updateMetaTags(house, imageUrl) {
            // Title
            document.title = `${house.title} | Prehouses`;

            // Meta Description
            const desc = `Compra ${house.title} por ${parseInt(house.price).toLocaleString()}€. ${house.description.substring(0, 150)}...`;
            setMetaTag('name', 'description', desc);

            // Open Graph (Facebook, LinkedIn, WhatsApp)
            setMetaTag('property', 'og:title', `${house.title} | Prehouses`);
            setMetaTag('property', 'og:description', desc);
            setMetaTag('property', 'og:image', imageUrl);
            setMetaTag('property', 'og:url', window.location.href);
            setMetaTag('property', 'og:type', 'product');

            // Twitter Card
            setMetaTag('name', 'twitter:card', 'summary_large_image');
            setMetaTag('name', 'twitter:title', `${house.title} | Prehouses`);
            setMetaTag('name', 'twitter:description', desc);
            setMetaTag('name', 'twitter:image', imageUrl);
        }

        function setMetaTag(attrName, attrValue, content) {
            let element = document.querySelector(`meta[${attrName}="${attrValue}"]`);
            if (!element) {
                element = document.createElement('meta');
                element.setAttribute(attrName, attrValue);
                document.head.appendChild(element);
            }
            element.setAttribute('content', content);
        }

        async function loadSimilarHouses(category) {
            if (!category) {
                document.getElementById('similarHousesSection').style.display = 'none';
                return;
            }

            const container = document.getElementById('similarHousesGrid');
            try {
                const snapshot = await db.collection('houses')
                    .where('category', '==', category)
                    .limit(4)
                    .get();

                let html = '';
                let count = 0;

                snapshot.forEach(doc => {
                    if (doc.id === houseId || count >= 3) return;

                    const house = doc.data();
                    const img = Array.isArray(house.images) ? house.images[0] : (house.image || 'https://via.placeholder.com/400');

                    html += `
                        <a href="detalle-casa.html?id=${doc.id}" class="house-card">
                            <div class="house-image">
                                <img src="${img}" alt="${house.title}" onerror="this.src='https://via.placeholder.com/400'">
                            </div>
                            <div class="house-content">
                                <div class="house-header">
                                    <div class="house-price">${parseInt(house.price).toLocaleString()}€</div>
                                </div>
                                <h3 class="house-title">${house.title}</h3>
                                <div class="house-footer">
                                    <span class="btn btn-outline" style="width: 100%; text-align: center;">Ver Casa</span>
                                </div>
                            </div>
                        </a>
                    `;
                    count++;
                });

                if (html) {
                    container.innerHTML = html;
                } else {
                    document.getElementById('similarHousesSection').style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading similar houses:', error);
                document.getElementById('similarHousesSection').style.display = 'none';
            }
        }

        // Send Lead
        async function sendLead(e) {
            e.preventDefault();
            const btn = document.getElementById('leadBtn');
            btn.disabled = true;
            btn.innerText = 'Enviando...';

            try {
                await db.collection('leads').add({
                    houseId: houseId,
                    houseTitle: currentHouse.title,
                    companyId: currentHouse.companyId,
                    userName: document.getElementById('leadName').value,
                    userEmail: document.getElementById('leadEmail').value,
                    userPhone: document.getElementById('leadPhone').value,
                    message: document.getElementById('leadMessage').value,
                    status: 'nuevo',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('✅ Solicitud enviada correctamente. La empresa te contactará pronto.');
                e.target.reset();
            } catch (error) {
                console.error('Error sending lead:', error);
                alert('Error al enviar solicitud');
            } finally {
                btn.disabled = false;
                btn.innerText = 'Enviar Solicitud';
            }
        }

        // Favorites Logic
        function updateFavUI(isSaved) {
            const mainBtn = document.getElementById('favBtn');
            const mobBtn = document.getElementById('mobileFavBtn');

            if (isSaved) {
                if (mainBtn) mainBtn.innerHTML = '<i class="fa-solid fa-heart" style="color: red;"></i> Guardado';
                if (mobBtn) {
                    mobBtn.innerHTML = '<i class="fa-solid fa-heart"></i>';
                    mobBtn.classList.add('active');
                }
            } else {
                if (mainBtn) mainBtn.innerHTML = '<i class="fa-regular fa-heart"></i> Guardar Favorito';
                if (mobBtn) {
                    mobBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
                    mobBtn.classList.remove('active');
                }
            }
        }

        async function checkFavorite() {
            if (!currentUser || !houseId) return;
            const snap = await db.collection('favorites')
                .where('userId', '==', currentUser.uid)
                .where('houseId', '==', houseId)
                .get();

            if (!snap.empty) {
                updateFavUI(true);
            }
        }

        async function toggleFavorite() {
            if (!currentUser) return alert('Debes iniciar sesión para guardar favoritos.');

            const btn = document.getElementById('favBtn');
            const isSaved = btn.innerHTML.includes('fa-solid');

            // Optimistic UI update
            updateFavUI(!isSaved);

            try {
                if (isSaved) {
                    // Remove
                    const snap = await db.collection('favorites')
                        .where('userId', '==', currentUser.uid)
                        .where('houseId', '==', houseId)
                        .get();
                    snap.forEach(doc => doc.ref.delete());
                    // console.log('Removed'); 
                } else {
                    // Add
                    await db.collection('favorites').add({
                        userId: currentUser.uid,
                        houseId: houseId,
                        houseTitle: currentHouse.title,
                        housePrice: currentHouse.price,
                        houseImage: document.getElementById('houseImage').src,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    // console.log('Added');
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
                // Revert UI on error
                updateFavUI(isSaved);
                alert('Error al guardar favorito');
            }
        }

        // Init
        loadHouse();
    </script>

</body>

</html>